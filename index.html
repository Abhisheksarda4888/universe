<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>AR SOLAR SYSTEM</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Exo+2:wght@100;300;700;900&family=Share+Tech+Mono&display=swap');
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
  --cyan:#00eeff;--cyan2:rgba(0,238,255,0.25);--warn:#ff5500;--ok:#00ff99;
  --bg:rgba(0,8,24,0.82);--font:'Share Tech Mono',monospace;--ui:'Exo 2',sans-serif;
}
html,body{width:100%;height:100%;overflow:hidden;background:#000;font-family:var(--font)}
#video{position:fixed;inset:0;width:100%;height:100%;object-fit:cover;transform:scaleX(-1);z-index:0;opacity:0;transition:opacity 1.2s}
#video.on{opacity:1}
#three-canvas{position:fixed;inset:0;z-index:2;pointer-events:none}
#hand-canvas{position:fixed;inset:0;z-index:3;pointer-events:none;transform:scaleX(-1)}
body::after{content:'';position:fixed;inset:0;z-index:4;pointer-events:none;
  background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.04) 2px,rgba(0,0,0,0.04) 4px)}
#hud{position:fixed;inset:0;z-index:10;pointer-events:none}
.crn{position:absolute;width:52px;height:52px;border-color:var(--cyan);border-style:solid;opacity:.6}
.tl{top:14px;left:14px;border-width:2px 0 0 2px}.tr{top:14px;right:14px;border-width:2px 2px 0 0}
.bl{bottom:14px;left:14px;border-width:0 0 2px 2px}.br{bottom:14px;right:14px;border-width:0 2px 2px 0}
#topbar{position:absolute;top:0;left:0;right:0;padding:18px 80px;display:flex;justify-content:space-between;align-items:center;background:linear-gradient(to bottom,rgba(0,5,20,.92) 0%,transparent 100%)}
#logo{font-family:var(--ui);font-weight:900;letter-spacing:.5em;font-size:clamp(11px,2vw,17px);color:var(--cyan);text-shadow:0 0 24px rgba(0,238,255,.7);text-transform:uppercase}
#logo span{opacity:.4;font-weight:100}
#pills{display:flex;gap:12px}
.pill{font-size:8px;letter-spacing:.15em;padding:4px 10px;border:1px solid var(--cyan2);color:var(--cyan2);display:flex;align-items:center;gap:5px;transition:all .3s}
.pill.on{border-color:var(--ok);color:var(--ok)}.pill.warn{border-color:var(--warn);color:var(--warn)}
.dot{width:5px;height:5px;border-radius:50%;background:currentColor;animation:blink 1s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.15}}
#gestures{position:absolute;top:50%;right:18px;transform:translateY(-50%);display:flex;flex-direction:column;gap:7px}
.gst{font-size:9px;letter-spacing:.08em;color:var(--cyan2);display:flex;align-items:center;gap:8px;padding:7px 10px;border:1px solid rgba(0,238,255,.1);background:rgba(0,8,24,.6);transition:all .25s}
.gst.active{color:var(--cyan);border-color:rgba(0,238,255,.5);background:rgba(0,238,255,.07);box-shadow:0 0 12px rgba(0,238,255,.15)}
.gi{font-size:18px;min-width:22px;text-align:center}
#pinfo{position:absolute;left:18px;top:50%;transform:translateY(-50%);width:210px;background:var(--bg);border:1px solid var(--cyan2);backdrop-filter:blur(14px);padding:16px;opacity:0;transition:opacity .4s;clip-path:polygon(0 0,calc(100% - 10px) 0,100% 10px,100% 100%,10px 100%,0 calc(100% - 10px))}
#pinfo.show{opacity:1}
#pinfo .pname{font-family:var(--ui);font-weight:900;font-size:16px;letter-spacing:.2em;color:var(--cyan);text-transform:uppercase;margin-bottom:10px}
#pinfo .prow{font-size:9px;letter-spacing:.1em;color:rgba(255,255,255,.55);padding:4px 0;border-bottom:1px solid rgba(0,238,255,.08);display:flex;justify-content:space-between}
#pinfo .prow span{color:rgba(255,255,255,.9)}
#btmbar{position:absolute;bottom:0;left:0;right:0;padding:16px 80px;background:linear-gradient(to top,rgba(0,5,20,.9) 0%,transparent 100%);display:flex;justify-content:space-between;align-items:flex-end}
#controls{display:flex;gap:8px;flex-wrap:wrap;pointer-events:auto}
.btn{font-family:var(--ui);font-weight:700;font-size:9px;letter-spacing:.18em;padding:8px 14px;border:1px solid var(--cyan2);background:rgba(0,8,24,.7);color:var(--cyan2);cursor:pointer;transition:all .2s;text-transform:uppercase;clip-path:polygon(5px 0%,100% 0%,calc(100% - 5px) 100%,0% 100%)}
.btn:hover,.btn.on{border-color:var(--cyan);color:var(--cyan);background:rgba(0,238,255,.1);box-shadow:0 0 16px rgba(0,238,255,.2)}
#cam-tip{font-size:9px;letter-spacing:.1em;color:rgba(255,255,255,.3)}
#splash{position:fixed;inset:0;z-index:100;background:#000010;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px;transition:opacity 1.2s}
#splash.gone{opacity:0;pointer-events:none}
#splash h1{font-family:var(--ui);font-weight:900;letter-spacing:.5em;font-size:clamp(18px,4vw,36px);color:var(--cyan);text-shadow:0 0 40px rgba(0,238,255,.6)}
#splash p{font-size:11px;letter-spacing:.25em;color:rgba(255,255,255,.4)}
#progress-bar{width:260px;height:2px;background:rgba(0,238,255,.15);position:relative;overflow:hidden}
#progress-fill{height:100%;background:var(--cyan);width:0%;transition:width .3s;box-shadow:0 0 12px var(--cyan)}
#allow-cam{font-family:var(--ui);font-weight:700;font-size:11px;letter-spacing:.25em;padding:12px 30px;border:1px solid var(--cyan);background:transparent;color:var(--cyan);cursor:pointer;text-transform:uppercase;margin-top:10px;transition:all .2s;pointer-events:auto}
#allow-cam:hover{background:rgba(0,238,255,.12);box-shadow:0 0 24px rgba(0,238,255,.3)}
#gflash{position:fixed;inset:0;z-index:50;pointer-events:none;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .3s}
#gflash-text{font-family:var(--ui);font-weight:900;font-size:clamp(20px,5vw,40px);letter-spacing:.4em;color:var(--cyan);text-shadow:0 0 40px rgba(0,238,255,.9);text-transform:uppercase}
#reticle{position:fixed;z-index:6;pointer-events:none;width:40px;height:40px;transform:translate(-50%,-50%);opacity:0;transition:opacity .3s}
#reticle svg{width:100%;height:100%}
</style>
</head>
<body>
<video id="video" playsinline autoplay muted></video>
<canvas id="three-canvas"></canvas>
<canvas id="hand-canvas"></canvas>
<div id="reticle"><svg viewBox="0 0 40 40" fill="none"><circle cx="20" cy="20" r="8" stroke="#00eeff" stroke-width="1" opacity=".7"/><line x1="20" y1="2" x2="20" y2="12" stroke="#00eeff" stroke-width="1" opacity=".7"/><line x1="20" y1="28" x2="20" y2="38" stroke="#00eeff" stroke-width="1" opacity=".7"/><line x1="2" y1="20" x2="12" y2="20" stroke="#00eeff" stroke-width="1" opacity=".7"/><line x1="28" y1="20" x2="38" y2="20" stroke="#00eeff" stroke-width="1" opacity=".7"/></svg></div>
<div id="gflash"><div id="gflash-text"></div></div>
<div id="hud">
  <div class="crn tl"></div><div class="crn tr"></div><div class="crn bl"></div><div class="crn br"></div>
  <div id="topbar">
    <div id="logo">AR <span>¬∑</span> SOLAR SYSTEM <span>¬∑</span> UNIVERSE</div>
    <div id="pills">
      <div class="pill warn" id="cam-pill"><div class="dot"></div>CAMERA OFF</div>
      <div class="pill" id="hand-pill"><div class="dot"></div>HANDS: STANDBY</div>
      <div class="pill on" id="sys-pill"><div class="dot"></div>SYSTEM ONLINE</div>
    </div>
  </div>
  <div id="gestures">
    <div class="gst" id="g-pinch"><span class="gi">ü§å</span>PINCH ‚Äî ZOOM</div>
    <div class="gst" id="g-grab"><span class="gi">‚úä</span>FIST ‚Äî ROTATE</div>
    <div class="gst" id="g-point"><span class="gi">‚òùÔ∏è</span>POINT ‚Äî SELECT</div>
    <div class="gst" id="g-open"><span class="gi">üñêÔ∏è</span>OPEN ‚Äî TILT</div>
    <div class="gst" id="g-swipe"><span class="gi">üëã</span>SWIPE ‚Äî NEXT PLANET</div>
  </div>
  <div id="pinfo">
    <div class="pname" id="pname">‚Äî</div>
    <div class="prow">Diameter <span id="p-dia">‚Äî</span></div>
    <div class="prow">Dist. from Sun <span id="p-dist">‚Äî</span></div>
    <div class="prow">Orbital Period <span id="p-orb">‚Äî</span></div>
    <div class="prow">Rotation <span id="p-rot">‚Äî</span></div>
    <div class="prow">Moons <span id="p-moons">‚Äî</span></div>
    <div class="prow">Avg Temp <span id="p-temp">‚Äî</span></div>
  </div>
  <div id="btmbar">
    <div id="controls">
      <button class="btn on" onclick="toggleAR()" id="btn-ar">‚¨§ AR MODE</button>
      <button class="btn on" onclick="toggleOrbits()" id="btn-orbits">‚óØ ORBITS</button>
      <button class="btn on" onclick="toggleLabels()" id="btn-labels">‚üÅ LABELS</button>
      <button class="btn" onclick="togglePause()" id="btn-pause">‚è∏ PAUSE</button>
      <button class="btn" onclick="resetCamera()">‚åñ RESET</button>
      <button class="btn" onclick="toggleSpeed()" id="btn-speed">‚ö° √ó1</button>
    </div>
    <div id="cam-tip">FRONT CAMERA ¬∑ GESTURE CONTROL ¬∑ CLICK PLANET TO SELECT</div>
  </div>
</div>
<div id="splash">
  <h1>SOLAR SYSTEM</h1>
  <p>AUGMENTED REALITY ¬∑ GESTURE CONTROL ¬∑ 3D UNIVERSE</p>
  <div id="progress-bar"><div id="progress-fill"></div></div>
  <p id="splash-status" style="font-size:10px;letter-spacing:.2em;color:rgba(0,238,255,.5)">INITIALIZING...</p>
  <button id="allow-cam" onclick="initCamera()">‚¨§ ENABLE CAMERA & LAUNCH</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
<script>
// ‚îÄ‚îÄ PLANET DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const PLANETS=[
  {name:'Mercury',radius:.18,dist:5,speed:4.15,tilt:.03,
   colors:['#8c7b6b','#6b5a52','#9e8d82','#7a6960','#b0a098'],type:'rocky',rings:false,hasMoon:false,
   info:{dia:'4,879 km',dist:'57.9M km',orb:'88 days',rot:'58.6 days',moons:'0',temp:'167¬∞C'}},
  {name:'Venus',radius:.44,dist:7.2,speed:1.62,tilt:177.4,
   colors:['#e8cda0','#c9aa7a','#f0d8b0','#d4b887','#e0c090'],type:'rocky',rings:false,hasMoon:false,
   info:{dia:'12,104 km',dist:'108.2M km',orb:'225 days',rot:'243 days',moons:'0',temp:'464¬∞C'}},
  {name:'Earth',radius:.46,dist:10,speed:1.0,tilt:23.4,
   colors:['#2a6bcc','#1a4a8a','#3a8a3a','#8a6a2a','#ffffff'],type:'earth',rings:false,hasMoon:true,
   info:{dia:'12,742 km',dist:'149.6M km',orb:'365 days',rot:'24 hrs',moons:'1',temp:'15¬∞C'}},
  {name:'Mars',radius:.26,dist:14,speed:.53,tilt:25.2,
   colors:['#c1440e','#8b3010','#d4562a','#a03818','#e06030'],type:'rocky',rings:false,hasMoon:false,
   info:{dia:'6,779 km',dist:'227.9M km',orb:'687 days',rot:'24.6 hrs',moons:'2',temp:'-65¬∞C'}},
  {name:'Jupiter',radius:1.2,dist:20,speed:.084,tilt:3.1,
   colors:['#c88b3a','#e8c07a','#a06030','#d4a060','#f0d090','#8a4a20'],type:'gas',rings:false,hasMoon:false,
   info:{dia:'139,820 km',dist:'778.5M km',orb:'11.9 yrs',rot:'10 hrs',moons:'95',temp:'-110¬∞C'}},
  {name:'Saturn',radius:1.0,dist:28,speed:.034,tilt:26.7,
   colors:['#e8d090','#c8b060','#f0dca0','#d4bc70','#b89040'],type:'gas',rings:true,hasMoon:false,
   info:{dia:'116,460 km',dist:'1.43B km',orb:'29.5 yrs',rot:'10.7 hrs',moons:'146',temp:'-140¬∞C'}},
  {name:'Uranus',radius:.7,dist:35,speed:.012,tilt:97.8,
   colors:['#7de8e8','#60d0d8','#90f0f0','#70c8d0','#a0f8f8'],type:'ice',rings:true,hasMoon:false,
   info:{dia:'50,724 km',dist:'2.87B km',orb:'84 yrs',rot:'17.2 hrs',moons:'27',temp:'-195¬∞C'}},
  {name:'Neptune',radius:.68,dist:42,speed:.006,tilt:28.3,
   colors:['#3050d8','#2040b0','#4070f0','#3060d0','#1030a0'],type:'ice',rings:false,hasMoon:false,
   info:{dia:'49,244 km',dist:'4.5B km',orb:'165 yrs',rot:'16.1 hrs',moons:'16',temp:'-200¬∞C'}}
];

// ‚îÄ‚îÄ THREE.JS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const canvas3d=document.getElementById('three-canvas');
const renderer=new THREE.WebGLRenderer({canvas:canvas3d,antialias:true,alpha:true});
renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
renderer.setSize(window.innerWidth,window.innerHeight);
renderer.shadowMap.enabled=true;
const scene=new THREE.Scene();
const camera=new THREE.PerspectiveCamera(60,window.innerWidth/window.innerHeight,.1,2000);
camera.position.set(0,22,58);
window.addEventListener('resize',()=>{
  renderer.setSize(window.innerWidth,window.innerHeight);
  camera.aspect=window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  hCanvas.width=window.innerWidth;hCanvas.height=window.innerHeight;
});

// Lighting
scene.add(new THREE.AmbientLight(0x111133,.5));
const sunLight=new THREE.PointLight(0xfff5e0,4,400);
scene.add(sunLight);
scene.add(Object.assign(new THREE.DirectionalLight(0x4488ff,.3),{position:new THREE.Vector3(-50,30,-50)}));

// ‚îÄ‚îÄ TEXTURE HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function mkTex(colors,sz,type){
  const c=document.createElement('canvas');c.width=sz;c.height=sz;
  const x=c.getContext('2d');
  x.fillStyle=colors[0];x.fillRect(0,0,sz,sz);

  if(type==='earth'){
    // Ocean
    x.fillStyle='#1a4a9a';x.fillRect(0,0,sz,sz);
    // Continents
    [[.28,.38,.15,.20,-.3],[.52,.36,.17,.22,.2],[.68,.58,.09,.15,.5],[.22,.64,.10,.09,.1],[.44,.70,.14,.07,.4],[.1,.28,.06,.11,.2]].forEach(([cx2,cy2,rx,ry,rot])=>{
      x.save();x.translate(cx2*sz,cy2*sz);x.rotate(rot);
      const g=x.createRadialGradient(0,0,0,0,0,rx*sz);
      g.addColorStop(0,'#4a8a3a');g.addColorStop(.6,'#3a6a2a');g.addColorStop(1,'transparent');
      x.fillStyle=g;x.globalAlpha=1;x.beginPath();x.ellipse(0,0,rx*sz,ry*sz,0,0,Math.PI*2);x.fill();x.restore();
    });
    // Ice caps
    let ig=x.createLinearGradient(0,0,0,sz*.14);ig.addColorStop(0,'#ffffff');ig.addColorStop(1,'transparent');
    x.fillStyle=ig;x.globalAlpha=.9;x.fillRect(0,0,sz,sz*.11);
    ig=x.createLinearGradient(0,sz*.87,0,sz);ig.addColorStop(0,'transparent');ig.addColorStop(1,'#e0eeff');
    x.fillStyle=ig;x.fillRect(0,sz*.88,sz,sz*.12);
    // Clouds
    x.globalAlpha=.3;
    for(let i=0;i<20;i++){const px=Math.random()*sz,py=Math.random()*sz,r=18+Math.random()*55;const g=x.createRadialGradient(px,py,0,px,py,r);g.addColorStop(0,'#fff');g.addColorStop(1,'transparent');x.fillStyle=g;x.beginPath();x.ellipse(px,py,r,r*.5,Math.random()*Math.PI,0,Math.PI*2);x.fill();}
  } else if(type==='gas'){
    // Horizontal bands
    for(let i=0;i<16;i++){
      const y=i/16*sz,bh=sz/16*(0.6+Math.random()*.8);
      const g=x.createLinearGradient(0,y,0,y+bh);
      g.addColorStop(0,colors[i%colors.length]);g.addColorStop(.5,colors[(i+1)%colors.length]);g.addColorStop(1,colors[(i+2)%colors.length]);
      x.fillStyle=g;x.globalAlpha=.75;x.fillRect(0,y,sz,bh+2);
    }
    // Swirls
    x.globalAlpha=.12;
    for(let i=0;i<25;i++){const px=Math.random()*sz,py=Math.random()*sz,r=15+Math.random()*55;const g=x.createRadialGradient(px,py,0,px,py,r);g.addColorStop(0,colors[i%colors.length]);g.addColorStop(1,'transparent');x.fillStyle=g;x.beginPath();x.ellipse(px,py,r,r*.35,Math.random()*Math.PI,0,Math.PI*2);x.fill();}
    // Jupiter great red spot
    if(colors[0]==='#c88b3a'){x.globalAlpha=.85;const g=x.createRadialGradient(sz*.38,sz*.54,0,sz*.38,sz*.54,sz*.08);g.addColorStop(0,'#7a2808');g.addColorStop(.5,'#b83818');g.addColorStop(1,'transparent');x.fillStyle=g;x.beginPath();x.ellipse(sz*.38,sz*.54,sz*.09,sz*.055,0,0,Math.PI*2);x.fill();}
    // Saturn storm streak
    if(colors[0]==='#e8d090'){x.globalAlpha=.4;x.fillStyle='#fff8e0';x.beginPath();x.ellipse(sz*.6,sz*.3,sz*.06,sz*.015,0,0,Math.PI*2);x.fill();}
  } else if(type==='ice'){
    for(let i=0;i<10;i++){const y=i/10*sz;const g=x.createLinearGradient(0,y,0,y+sz/10);g.addColorStop(0,colors[i%colors.length]);g.addColorStop(1,colors[(i+1)%colors.length]);x.fillStyle=g;x.globalAlpha=.7;x.fillRect(0,y,sz,sz/10+1);}
    x.globalAlpha=.15;for(let i=0;i<35;i++){const px=Math.random()*sz,py=Math.random()*sz,r=4+Math.random()*18;x.fillStyle='#ffffff';x.beginPath();x.arc(px,py,r,0,Math.PI*2);x.fill();}
  } else {
    // Rocky with craters
    for(let i=0;i<7;i++){const y=i/7*sz;const g=x.createLinearGradient(0,y,0,y+sz/7);g.addColorStop(0,colors[i%colors.length]);g.addColorStop(1,colors[(i+1)%colors.length]);x.fillStyle=g;x.globalAlpha=.6;x.fillRect(0,y,sz,sz/7+2);}
    x.globalAlpha=.4;
    for(let i=0;i<60;i++){const px=Math.random()*sz,py=Math.random()*sz,r=2+Math.random()*18;const g=x.createRadialGradient(px-r*.3,py-r*.3,0,px,py,r);g.addColorStop(0,'rgba(255,255,255,.3)');g.addColorStop(.5,'rgba(0,0,0,.1)');g.addColorStop(1,'rgba(0,0,0,.4)');x.fillStyle=g;x.beginPath();x.arc(px,py,r,0,Math.PI*2);x.fill();}
    x.globalAlpha=.07;for(let i=0;i<400;i++){x.fillStyle=Math.random()>.5?'#fff':'#000';x.fillRect(Math.random()*sz,Math.random()*sz,2,2);}
  }
  x.globalAlpha=1;
  return new THREE.CanvasTexture(c);
}

function mkNormalTex(sz=256){
  const c=document.createElement('canvas');c.width=sz;c.height=sz;
  const x=c.getContext('2d');x.fillStyle='#8080ff';x.fillRect(0,0,sz,sz);
  for(let i=0;i<150;i++){const px=Math.random()*sz,py=Math.random()*sz,r=3+Math.random()*14;const g=x.createRadialGradient(px-r*.3,py-r*.3,0,px,py,r);g.addColorStop(0,'rgba(200,200,255,.3)');g.addColorStop(.5,'rgba(128,128,255,.1)');g.addColorStop(1,'transparent');x.fillStyle=g;x.beginPath();x.arc(px,py,r,0,Math.PI*2);x.fill();}
  return new THREE.CanvasTexture(c);
}

// ‚îÄ‚îÄ SUN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const sunC=document.createElement('canvas');sunC.width=512;sunC.height=512;
const sunX=sunC.getContext('2d');
const sg=sunX.createRadialGradient(256,256,0,256,256,256);
sg.addColorStop(0,'#ffffff');sg.addColorStop(.08,'#fff5c0');sg.addColorStop(.35,'#ffcc00');sg.addColorStop(.65,'#ff8800');sg.addColorStop(1,'#ff4400');
sunX.fillStyle=sg;sunX.fillRect(0,0,512,512);
sunX.globalAlpha=.25;for(let i=0;i<80;i++){const px=Math.random()*512,py=Math.random()*512,r=4+Math.random()*28;const g=sunX.createRadialGradient(px,py,0,px,py,r);g.addColorStop(0,'rgba(255,255,200,.5)');g.addColorStop(1,'transparent');sunX.fillStyle=g;sunX.beginPath();sunX.arc(px,py,r,0,Math.PI*2);sunX.fill();}
const sunMesh=new THREE.Mesh(new THREE.SphereGeometry(2.8,64,64),new THREE.MeshBasicMaterial({map:new THREE.CanvasTexture(sunC)}));
scene.add(sunMesh);

// Sun glow sprite
const glowC=document.createElement('canvas');glowC.width=256;glowC.height=256;
const glowX=glowC.getContext('2d');
const gg=glowX.createRadialGradient(128,128,0,128,128,128);
gg.addColorStop(0,'rgba(255,220,80,.6)');gg.addColorStop(.3,'rgba(255,150,0,.25)');gg.addColorStop(.7,'rgba(255,80,0,.07)');gg.addColorStop(1,'transparent');
glowX.fillStyle=gg;glowX.fillRect(0,0,256,256);
const sunGlow=new THREE.Sprite(new THREE.SpriteMaterial({map:new THREE.CanvasTexture(glowC),transparent:true,blending:THREE.AdditiveBlending}));
sunGlow.scale.set(18,18,1);scene.add(sunGlow);
// Corona shells
[{r:3.3,op:.07},{r:4.2,op:.03}].forEach(({r,op})=>{
  scene.add(new THREE.Mesh(new THREE.SphereGeometry(r,32,32),new THREE.MeshBasicMaterial({color:0xff6600,transparent:true,opacity:op,side:THREE.BackSide,blending:THREE.AdditiveBlending})));
});

// ‚îÄ‚îÄ STARS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function mkStars(count,rMin,rMax,color,size){
  const g=new THREE.BufferGeometry(),v=[];
  for(let i=0;i<count;i++){const r=rMin+Math.random()*(rMax-rMin),t=Math.random()*Math.PI*2,p=Math.acos(2*Math.random()-1);v.push(r*Math.sin(p)*Math.cos(t),r*Math.sin(p)*Math.sin(t),r*Math.cos(p));}
  g.setAttribute('position',new THREE.Float32BufferAttribute(v,3));
  return new THREE.Points(g,new THREE.PointsMaterial({color,size,sizeAttenuation:true,transparent:true,opacity:.8}));
}
scene.add(mkStars(4000,200,800,0xffffff,.45));
scene.add(mkStars(500,180,350,0x4488ff,.8));
scene.add(mkStars(300,180,350,0xff4488,.8));
scene.add(mkStars(200,180,350,0xffcc44,.7));

// ‚îÄ‚îÄ LABEL SPRITE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function mkLabel(name){
  const c=document.createElement('canvas');c.width=256;c.height=56;
  const x=c.getContext('2d');
  x.font='bold 26px "Exo 2",sans-serif';
  x.fillStyle='rgba(0,238,255,.9)';x.textAlign='center';x.textBaseline='middle';
  x.shadowColor='#00eeff';x.shadowBlur=10;
  x.fillText(name.toUpperCase(),128,28);
  const s=new THREE.Sprite(new THREE.SpriteMaterial({map:new THREE.CanvasTexture(c),transparent:true}));
  s.scale.set(4,1,1);return s;
}

// ‚îÄ‚îÄ ORBIT LINE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function mkOrbit(r){
  const pts=[];for(let i=0;i<=128;i++){const a=i/128*Math.PI*2;pts.push(new THREE.Vector3(Math.cos(a)*r,0,Math.sin(a)*r));}
  return new THREE.Line(new THREE.BufferGeometry().setFromPoints(pts),new THREE.LineBasicMaterial({color:0x00eeff,transparent:true,opacity:.13}));
}

// ‚îÄ‚îÄ RINGS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function mkRings(pd){
  const inner=pd.radius*1.35,outer=pd.radius*2.5;
  const geo=new THREE.RingGeometry(inner,outer,80,4);
  const pos=geo.attributes.position,uv=geo.attributes.uv;
  for(let i=0;i<pos.count;i++){const v=new THREE.Vector3().fromBufferAttribute(pos,i);uv.setXY(i,(v.length()-inner)/(outer-inner),.5);}
  const rc=document.createElement('canvas');rc.width=256;rc.height=4;
  const rx=rc.getContext('2d');
  const rg=rx.createLinearGradient(0,0,256,0);
  if(pd.name==='Saturn'){rg.addColorStop(0,'rgba(200,180,100,0)');rg.addColorStop(.1,'rgba(200,180,100,.75)');rg.addColorStop(.3,'rgba(170,150,70,.4)');rg.addColorStop(.5,'rgba(220,200,120,.85)');rg.addColorStop(.7,'rgba(155,135,55,.35)');rg.addColorStop(.9,'rgba(180,160,80,.5)');rg.addColorStop(1,'rgba(200,180,100,0)');}
  else{rg.addColorStop(0,'rgba(120,220,220,0)');rg.addColorStop(.3,'rgba(120,220,220,.4)');rg.addColorStop(.6,'rgba(100,200,200,.2)');rg.addColorStop(1,'rgba(120,220,220,0)');}
  rx.fillStyle=rg;rx.fillRect(0,0,256,4);
  const m=new THREE.Mesh(geo,new THREE.MeshBasicMaterial({map:new THREE.CanvasTexture(rc),transparent:true,side:THREE.DoubleSide,depthWrite:false}));
  m.rotation.x=Math.PI/2;return m;
}

// ‚îÄ‚îÄ BUILD PLANETS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const planetMeshes=[],orbitLines=[],labels=[];
let selectedPlanet=null,showOrbits=true,showLabels=true;

PLANETS.forEach((pd,i)=>{
  const tex=mkTex(pd.colors,512,pd.type);
  const mat=new THREE.MeshStandardMaterial({map:tex,roughness:pd.type==='gas'?.7:pd.type==='earth'?.55:.9,metalness:pd.name==='Mercury'?.2:0,normalMap:(pd.type==='rocky'||pd.type==='earth')?mkNormalTex():null,normalScale:new THREE.Vector2(.5,.5)});
  const mesh=new THREE.Mesh(new THREE.SphereGeometry(pd.radius,64,64),mat);
  mesh.castShadow=true;mesh.receiveShadow=true;
  mesh.rotation.z=THREE.MathUtils.degToRad(pd.tilt);
  mesh.userData={pd,angle:Math.random()*Math.PI*2};

  // Atmosphere
  if(['Earth','Venus','Neptune','Uranus'].includes(pd.name)){
    const ac={Earth:0x4488ff,Venus:0xffcc88,Neptune:0x2244ff,Uranus:0x44eeee};
    mesh.add(new THREE.Mesh(new THREE.SphereGeometry(pd.radius*1.06,32,32),new THREE.MeshBasicMaterial({color:ac[pd.name],transparent:true,opacity:.13,side:THREE.BackSide,blending:THREE.AdditiveBlending})));
  }

  if(pd.rings)mesh.add(mkRings(pd));

  // Moon
  if(pd.hasMoon){
    const moonTex=mkTex(['#aaaaaa','#888888','#999999','#777777'],256,'rocky');
    const moon=new THREE.Mesh(new THREE.SphereGeometry(.12,32,32),new THREE.MeshStandardMaterial({map:moonTex,roughness:1}));
    moon.userData={isMoon:true,angle:Math.random()*Math.PI*2};
    mesh.add(moon);
  }

  const orb=mkOrbit(pd.dist);
  scene.add(orb);orbitLines.push(orb);

  const lbl=mkLabel(pd.name);
  lbl.position.y=pd.radius+0.9;
  mesh.add(lbl);labels.push(lbl);

  scene.add(mesh);planetMeshes.push(mesh);
});

// Asteroid belt
(()=>{const g=new THREE.BufferGeometry(),v=[];for(let i=0;i<1500;i++){const r=16+Math.random()*2.8,a=Math.random()*Math.PI*2,h=(Math.random()-.5)*.4;v.push(Math.cos(a)*r,h,Math.sin(a)*r);}g.setAttribute('position',new THREE.Float32BufferAttribute(v,3));scene.add(new THREE.Points(g,new THREE.PointsMaterial({color:0x888877,size:.08,sizeAttenuation:true})));})();

// ‚îÄ‚îÄ HAND CANVAS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const hCanvas=document.getElementById('hand-canvas');
const hCtx=hCanvas.getContext('2d');
hCanvas.width=window.innerWidth;hCanvas.height=window.innerHeight;

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let arMode=true,paused=false,speedMult=1;
let gesture='none';
let pinchDist0=null,pinchZ0=null;
let grabStartX=null,grabStartY=null,grabRot0=null,grabElev0=null;
let targetZ=58,camRot=0,camElev=.35;
let prevHandX=null,swipeCooldown=0;
const clock=new THREE.Clock();

// ‚îÄ‚îÄ CAMERA INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const video=document.getElementById('video');

async function initCamera(){
  const splash=document.getElementById('splash');
  setProgress(30,'REQUESTING CAMERA...');
  try{
    const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'user',width:{ideal:1280},height:{ideal:720}},audio:false});
    video.srcObject=stream;video.classList.add('on');await video.play();
    setProgress(60,'CAMERA ACTIVE...');
    document.getElementById('cam-pill').innerHTML='<div class="dot"></div>CAMERA ON';
    document.getElementById('cam-pill').className='pill on';
    initMediaPipe();
  }catch(e){
    console.warn('Camera:',e);
    document.getElementById('cam-pill').innerHTML='<div class="dot"></div>NO CAMERA';
    document.getElementById('cam-pill').className='pill warn';
  }
  setProgress(100,'LAUNCHING...');
  setTimeout(()=>splash.classList.add('gone'),1000);
}
function setProgress(p,msg){document.getElementById('progress-fill').style.width=p+'%';document.getElementById('splash-status').textContent=msg;}
setProgress(5,'LOADING...');

// ‚îÄ‚îÄ MEDIAPIPE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initMediaPipe(){
  if(typeof Hands==='undefined'){console.warn('MediaPipe unavailable');return;}
  const hands=new Hands({locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
  hands.setOptions({maxNumHands:2,modelComplexity:1,minDetectionConfidence:.7,minTrackingConfidence:.6});
  hands.onResults(onHandResults);
  if(typeof Camera!=='undefined'){
    const cam=new Camera(video,{onFrame:async()=>await hands.send({image:video}),width:640,height:480});
    cam.start();
    document.getElementById('hand-pill').innerHTML='<div class="dot"></div>HANDS: ACTIVE';
    document.getElementById('hand-pill').className='pill on';
  }
}

const CONN=[[0,1],[1,2],[2,3],[3,4],[0,5],[5,6],[6,7],[7,8],[0,9],[9,10],[10,11],[11,12],[0,13],[13,14],[14,15],[15,16],[0,17],[17,18],[18,19],[19,20],[5,9],[9,13],[13,17]];
const TIPS=[4,8,12,16,20];
function d2(a,b){return Math.hypot(a.x-b.x,a.y-b.y);}

function detectGesture(lms){
  const tt=lms[4],it=lms[8],mt=lms[12],rt=lms[16],pt=lms[20];
  const im=lms[5],mm=lms[9],rm=lms[13],pm=lms[17];
  const pd=d2(tt,it);
  const iUp=it.y<im.y-.05,mUp=mt.y<mm.y-.05,rUp=rt.y<rm.y-.05,pUp=pt.y<pm.y-.05;
  if(pd<.06)return'pinch';
  if(!iUp&&!mUp&&!rUp&&!pUp)return'fist';
  if(iUp&&!mUp&&!rUp&&!pUp)return'point';
  if(iUp&&mUp&&rUp&&pUp)return'open';
  return'none';
}

function onHandResults(results){
  hCtx.clearRect(0,0,hCanvas.width,hCanvas.height);
  if(!results.multiHandLandmarks||!results.multiHandLandmarks.length){
    gesture='none';updateGestureUI();prevHandX=null;
    document.getElementById('reticle').style.opacity='0';return;
  }
  const W2=hCanvas.width,H2=hCanvas.height;
  const hands=results.multiHandLandmarks;
  hands.forEach(lms=>drawHand(lms,W2,H2));

  const lms=hands[0];
  gesture=detectGesture(lms);
  updateGestureUI();

  const it=lms[8],tt=lms[4],wr=lms[0];
  const rx=(1-it.x)*window.innerWidth,ry=it.y*window.innerHeight;
  const ret=document.getElementById('reticle');
  ret.style.left=rx+'px';ret.style.top=ry+'px';ret.style.opacity='1';

  // ‚îÄ‚îÄ PINCH = ZOOM ‚îÄ‚îÄ
  if(gesture==='pinch'){
    // Two-hand pinch-to-zoom
    if(hands.length>=2){
      const span=d2(lms[8],hands[1][8]);
      if(pinchDist0===null){pinchDist0=span;pinchZ0=targetZ;}
      else{targetZ=Math.max(6,Math.min(130,pinchZ0*(pinchDist0/Math.max(span,.01))));}
    } else {
      const pd2=d2(tt,it);
      if(pinchDist0===null){pinchDist0=pd2;pinchZ0=targetZ;}
      else{const delta=(pinchDist0-pd2)/Math.max(pinchDist0,.01);targetZ=Math.max(6,Math.min(130,pinchZ0+delta*90));}
    }
  } else {pinchDist0=null;}

  // ‚îÄ‚îÄ FIST = ROTATE ‚îÄ‚îÄ
  if(gesture==='fist'){
    if(grabStartX===null){grabStartX=wr.x;grabStartY=wr.y;grabRot0=camRot;grabElev0=camElev;}
    else{camRot=grabRot0+(grabStartX-wr.x)*5;camElev=grabElev0+(grabStartY-wr.y)*2.5;camElev=Math.max(-1.3,Math.min(1.3,camElev));}
  } else {grabStartX=null;grabStartY=null;}

  // ‚îÄ‚îÄ OPEN = TILT ‚îÄ‚îÄ
  if(gesture==='open'){
    if(grabStartY===null){grabStartY=wr.y;grabElev0=camElev;}
    else{camElev=grabElev0+(grabStartY-wr.y)*3;camElev=Math.max(-1.3,Math.min(1.3,camElev));}
  }

  // ‚îÄ‚îÄ SWIPE DETECTION ‚îÄ‚îÄ
  swipeCooldown=Math.max(0,swipeCooldown-1);
  if((gesture==='none'||gesture==='point')&&swipeCooldown===0){
    if(prevHandX!==null){
      const dx=wr.x-prevHandX;
      if(Math.abs(dx)>.14){
        const dir=dx>0?1:-1;
        const next=selectedPlanet!==null?(selectedPlanet+dir+PLANETS.length)%PLANETS.length:0;
        selectedPlanet=next;showPlanetInfo(next);swipeCooldown=35;
        flashGesture(PLANETS[next].name.toUpperCase());
      }
    }
    prevHandX=wr.x;
  } else if(gesture==='fist'||gesture==='open'){prevHandX=null;}

  // ‚îÄ‚îÄ POINT = SELECT ‚îÄ‚îÄ
  if(gesture==='point'&&swipeCooldown===0){
    const nx=(1-it.x)*2-1,ny=-it.y*2+1;
    const ray=new THREE.Raycaster();
    ray.setFromCamera(new THREE.Vector2(nx,ny),camera);
    const hits=ray.intersectObjects(planetMeshes,false);
    if(hits.length>0){const idx=planetMeshes.indexOf(hits[0].object);if(idx>=0&&idx!==selectedPlanet){selectedPlanet=idx;showPlanetInfo(idx);flashGesture(PLANETS[idx].name.toUpperCase());}}
  }
}

function drawHand(lms,W2,H2){
  CONN.forEach(([a,b])=>{
    const pa=lms[a],pb=lms[b];
    hCtx.beginPath();hCtx.moveTo(pa.x*W2,pa.y*H2);hCtx.lineTo(pb.x*W2,pb.y*H2);
    hCtx.strokeStyle='rgba(0,238,255,.65)';hCtx.lineWidth=2;hCtx.stroke();
  });
  lms.forEach((lm,i)=>{
    const tip=TIPS.includes(i);
    hCtx.beginPath();hCtx.arc(lm.x*W2,lm.y*H2,tip?7:4,0,Math.PI*2);
    hCtx.fillStyle=tip?'rgba(0,238,255,1)':'rgba(0,238,255,.65)';hCtx.fill();
    const g=hCtx.createRadialGradient(lm.x*W2,lm.y*H2,0,lm.x*W2,lm.y*H2,tip?14:8);
    g.addColorStop(0,'rgba(0,238,255,.3)');g.addColorStop(1,'transparent');
    hCtx.fillStyle=g;hCtx.beginPath();hCtx.arc(lm.x*W2,lm.y*H2,tip?14:8,0,Math.PI*2);hCtx.fill();
  });
}

function updateGestureUI(){
  const m={pinch:'g-pinch',fist:'g-grab',point:'g-point',open:'g-open'};
  document.querySelectorAll('.gst').forEach(e=>e.classList.remove('active'));
  if(m[gesture]){const el=document.getElementById(m[gesture]);if(el)el.classList.add('active');}
}

let flashTO=null;
function flashGesture(text){
  const el=document.getElementById('gflash'),tel=document.getElementById('gflash-text');
  tel.textContent=text;el.style.opacity='1';clearTimeout(flashTO);flashTO=setTimeout(()=>el.style.opacity='0',1000);
}

function showPlanetInfo(idx){
  const pd=PLANETS[idx];
  document.getElementById('pname').textContent=pd.name;
  document.getElementById('p-dia').textContent=pd.info.dia;
  document.getElementById('p-dist').textContent=pd.info.dist;
  document.getElementById('p-orb').textContent=pd.info.orb;
  document.getElementById('p-rot').textContent=pd.info.rot;
  document.getElementById('p-moons').textContent=pd.info.moons;
  document.getElementById('p-temp').textContent=pd.info.temp;
  document.getElementById('pinfo').classList.add('show');
}

// ‚îÄ‚îÄ CONTROLS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleAR(){arMode=!arMode;video.style.opacity=arMode?'1':'0';document.getElementById('btn-ar').classList.toggle('on',arMode);}
function toggleOrbits(){showOrbits=!showOrbits;orbitLines.forEach(o=>o.visible=showOrbits);document.getElementById('btn-orbits').classList.toggle('on',showOrbits);}
function toggleLabels(){showLabels=!showLabels;labels.forEach(l=>l.visible=showLabels);document.getElementById('btn-labels').classList.toggle('on',showLabels);}
function togglePause(){paused=!paused;document.getElementById('btn-pause').textContent=paused?'‚ñ∂ RESUME':'‚è∏ PAUSE';document.getElementById('btn-pause').classList.toggle('on',paused);}
function resetCamera(){targetZ=58;camRot=0;camElev=.35;selectedPlanet=null;document.getElementById('pinfo').classList.remove('show');}
const SPEEDS=[1,5,25,100];let sIdx=0;
function toggleSpeed(){sIdx=(sIdx+1)%SPEEDS.length;speedMult=SPEEDS[sIdx];document.getElementById('btn-speed').textContent='‚ö° √ó'+speedMult;}

// ‚îÄ‚îÄ MOUSE / TOUCH FALLBACK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let mDown=false,lmx=0,lmy=0;
canvas3d.style.pointerEvents='auto';
canvas3d.addEventListener('mousedown',e=>{if(e.button!==2){mDown=true;lmx=e.clientX;lmy=e.clientY;}});
window.addEventListener('mouseup',()=>mDown=false);
window.addEventListener('mousemove',e=>{
  if(!mDown)return;
  camRot-=(e.clientX-lmx)*.012;camElev+=(e.clientY-lmy)*.006;
  camElev=Math.max(-1.3,Math.min(1.3,camElev));lmx=e.clientX;lmy=e.clientY;
});
window.addEventListener('wheel',e=>{targetZ=Math.max(6,Math.min(130,targetZ+e.deltaY*.06));},{passive:true});
canvas3d.addEventListener('click',e=>{
  const nx=(e.clientX/window.innerWidth)*2-1,ny=-(e.clientY/window.innerHeight)*2+1;
  const ray=new THREE.Raycaster();ray.setFromCamera(new THREE.Vector2(nx,ny),camera);
  const hits=ray.intersectObjects(planetMeshes,false);
  if(hits.length>0){const idx=planetMeshes.indexOf(hits[0].object);if(idx>=0){selectedPlanet=idx;showPlanetInfo(idx);}}
  else{selectedPlanet=null;document.getElementById('pinfo').classList.remove('show');}
});
let tch0=null,tch1Span=null,tZ0=null;
window.addEventListener('touchstart',e=>{
  if(e.touches.length===1)tch0={x:e.touches[0].clientX,y:e.touches[0].clientY};
  if(e.touches.length===2){const dx=e.touches[0].clientX-e.touches[1].clientX,dy=e.touches[0].clientY-e.touches[1].clientY;tch1Span=Math.hypot(dx,dy);tZ0=targetZ;}
},{passive:true});
window.addEventListener('touchmove',e=>{
  if(e.touches.length===1&&tch0){camRot-=(e.touches[0].clientX-tch0.x)*.012;camElev+=(e.touches[0].clientY-tch0.y)*.006;camElev=Math.max(-1.3,Math.min(1.3,camElev));tch0={x:e.touches[0].clientX,y:e.touches[0].clientY};}
  if(e.touches.length===2&&tch1Span){const dx=e.touches[0].clientX-e.touches[1].clientX,dy=e.touches[0].clientY-e.touches[1].clientY;const span=Math.hypot(dx,dy);targetZ=Math.max(6,Math.min(130,tZ0*tch1Span/Math.max(span,1)));}
},{passive:true});

// ‚îÄ‚îÄ ANIMATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function animate(){
  requestAnimationFrame(animate);
  const dt=Math.min(clock.getDelta(),.05)*speedMult;

  if(!paused){
    sunMesh.rotation.y+=dt*.04;
    // Sun corona pulse
    const sp=.98+.02*Math.sin(Date.now()*.002);sunMesh.scale.set(sp,sp,sp);

    planetMeshes.forEach((mesh,i)=>{
      const pd=PLANETS[i];
      mesh.userData.angle+=dt*pd.speed*.1;
      mesh.position.x=Math.cos(mesh.userData.angle)*pd.dist;
      mesh.position.z=Math.sin(mesh.userData.angle)*pd.dist;
      mesh.rotation.y+=dt*(pd.name==='Venus'?-.25:.4);

      // Moon
      const moon=mesh.children.find(c=>c.userData.isMoon);
      if(moon){moon.userData.angle=(moon.userData.angle||0)+dt*2.2;moon.position.x=Math.cos(moon.userData.angle)*.85;moon.position.z=Math.sin(moon.userData.angle)*.85;}

      // Selection pulse
      if(selectedPlanet===i){const s=1+.04*Math.sin(Date.now()*.006);mesh.scale.set(s,s,s);}
      else mesh.scale.set(1,1,1);
    });
  }

  // Smooth camera
  const cz=camera.position.length();
  const smoothZ=cz+(targetZ-cz)*.1;
  camera.position.x=Math.sin(camRot)*smoothZ*Math.cos(camElev);
  camera.position.y=Math.sin(camElev)*smoothZ;
  camera.position.z=Math.cos(camRot)*smoothZ*Math.cos(camElev);

  if(selectedPlanet!==null)camera.lookAt(planetMeshes[selectedPlanet].position);
  else camera.lookAt(0,0,0);

  // Billboard labels
  labels.forEach(l=>l.quaternion.copy(camera.quaternion));

  renderer.render(scene,camera);
}
animate();
</script>
</body>
</html>
