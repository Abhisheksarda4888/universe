<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>AR SOLAR SYSTEM</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Exo+2:wght@100;300;700;900&family=Share+Tech+Mono&display=swap');
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
  --cyan:#00eeff;--cyan2:rgba(0,238,255,0.25);--warn:#ff5500;--ok:#00ff99;
  --bg:rgba(0,8,24,0.88);--font:'Share Tech Mono',monospace;--ui:'Exo 2',sans-serif;
}
html,body{width:100%;height:100%;overflow:hidden;background:#000306;font-family:var(--font)}
#video{position:fixed;inset:0;width:100%;height:100%;object-fit:cover;transform:scaleX(-1);z-index:0;opacity:0;transition:opacity 1.2s}
#video.on{opacity:1}
#three-canvas{position:fixed;inset:0;z-index:2;pointer-events:none}
#hand-canvas{position:fixed;inset:0;z-index:3;pointer-events:none;transform:scaleX(-1)}
body::after{content:'';position:fixed;inset:0;z-index:4;pointer-events:none;
  background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.03) 2px,rgba(0,0,0,0.03) 4px)}
#hud{position:fixed;inset:0;z-index:10;pointer-events:none}
.crn{position:absolute;width:52px;height:52px;border-color:var(--cyan);border-style:solid;opacity:.5}
.tl{top:14px;left:14px;border-width:2px 0 0 2px}.tr{top:14px;right:14px;border-width:2px 2px 0 0}
.bl{bottom:14px;left:14px;border-width:0 0 2px 2px}.br{bottom:14px;right:14px;border-width:0 2px 2px 0}
#topbar{position:absolute;top:0;left:0;right:0;padding:18px 80px;display:flex;justify-content:space-between;align-items:center;background:linear-gradient(to bottom,rgba(0,5,20,.95) 0%,transparent 100%)}
#logo{font-family:var(--ui);font-weight:900;letter-spacing:.5em;font-size:clamp(11px,2vw,17px);color:var(--cyan);text-shadow:0 0 24px rgba(0,238,255,.7);text-transform:uppercase}
#logo span{opacity:.4;font-weight:100}
#pills{display:flex;gap:12px}
.pill{font-size:8px;letter-spacing:.15em;padding:4px 10px;border:1px solid var(--cyan2);color:var(--cyan2);display:flex;align-items:center;gap:5px;transition:all .3s}
.pill.on{border-color:var(--ok);color:var(--ok)}.pill.warn{border-color:var(--warn);color:var(--warn)}
.dot{width:5px;height:5px;border-radius:50%;background:currentColor;animation:blink 1s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.15}}
#gestures{position:absolute;top:50%;right:18px;transform:translateY(-50%);display:flex;flex-direction:column;gap:7px}
.gst{font-size:9px;letter-spacing:.08em;color:var(--cyan2);display:flex;align-items:center;gap:8px;padding:7px 10px;border:1px solid rgba(0,238,255,.1);background:rgba(0,8,24,.6);transition:all .25s}
.gst.active{color:var(--cyan);border-color:rgba(0,238,255,.5);background:rgba(0,238,255,.07);box-shadow:0 0 12px rgba(0,238,255,.15)}
.gi{font-size:18px;min-width:22px;text-align:center}
#pinfo{position:absolute;left:18px;top:50%;transform:translateY(-50%);width:210px;background:var(--bg);border:1px solid var(--cyan2);backdrop-filter:blur(14px);padding:16px;opacity:0;transition:opacity .4s;clip-path:polygon(0 0,calc(100% - 10px) 0,100% 10px,100% 100%,10px 100%,0 calc(100% - 10px))}
#pinfo.show{opacity:1}
#pinfo .pname{font-family:var(--ui);font-weight:900;font-size:16px;letter-spacing:.2em;color:var(--cyan);text-transform:uppercase;margin-bottom:10px}
#pinfo .prow{font-size:9px;letter-spacing:.1em;color:rgba(255,255,255,.55);padding:4px 0;border-bottom:1px solid rgba(0,238,255,.08);display:flex;justify-content:space-between}
#pinfo .prow span{color:rgba(255,255,255,.9)}
#btmbar{position:absolute;bottom:0;left:0;right:0;padding:16px 80px;background:linear-gradient(to top,rgba(0,5,20,.9) 0%,transparent 100%);display:flex;justify-content:space-between;align-items:flex-end}
#controls{display:flex;gap:8px;flex-wrap:wrap;pointer-events:auto}
.btn{font-family:var(--ui);font-weight:700;font-size:9px;letter-spacing:.18em;padding:8px 14px;border:1px solid var(--cyan2);background:rgba(0,8,24,.7);color:var(--cyan2);cursor:pointer;transition:all .2s;text-transform:uppercase;clip-path:polygon(5px 0%,100% 0%,calc(100% - 5px) 100%,0% 100%)}
.btn:hover,.btn.on{border-color:var(--cyan);color:var(--cyan);background:rgba(0,238,255,.1);box-shadow:0 0 16px rgba(0,238,255,.2)}
#cam-tip{font-size:9px;letter-spacing:.1em;color:rgba(255,255,255,.3)}
#splash{position:fixed;inset:0;z-index:100;background:#000010;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px;transition:opacity 1.2s}
#splash.gone{opacity:0;pointer-events:none}
#splash h1{font-family:var(--ui);font-weight:900;letter-spacing:.5em;font-size:clamp(18px,4vw,36px);color:var(--cyan);text-shadow:0 0 40px rgba(0,238,255,.6)}
#splash p{font-size:11px;letter-spacing:.25em;color:rgba(255,255,255,.4)}
#progress-bar{width:260px;height:2px;background:rgba(0,238,255,.15);position:relative;overflow:hidden}
#progress-fill{height:100%;background:var(--cyan);width:0%;transition:width .3s;box-shadow:0 0 12px var(--cyan)}
#allow-cam{font-family:var(--ui);font-weight:700;font-size:11px;letter-spacing:.25em;padding:12px 30px;border:1px solid var(--cyan);background:transparent;color:var(--cyan);cursor:pointer;text-transform:uppercase;margin-top:10px;transition:all .2s;pointer-events:auto}
#allow-cam:hover{background:rgba(0,238,255,.12);box-shadow:0 0 24px rgba(0,238,255,.3)}
#skip-cam{font-family:var(--ui);font-size:10px;letter-spacing:.2em;padding:8px 20px;border:1px solid rgba(255,255,255,.15);background:transparent;color:rgba(255,255,255,.35);cursor:pointer;text-transform:uppercase;transition:all .2s;pointer-events:auto}
#skip-cam:hover{color:rgba(255,255,255,.6);border-color:rgba(255,255,255,.3)}
#gflash{position:fixed;inset:0;z-index:50;pointer-events:none;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .3s}
#gflash-text{font-family:var(--ui);font-weight:900;font-size:clamp(20px,5vw,40px);letter-spacing:.4em;color:var(--cyan);text-shadow:0 0 40px rgba(0,238,255,.9);text-transform:uppercase}
#reticle{position:fixed;z-index:6;pointer-events:none;width:40px;height:40px;transform:translate(-50%,-50%);opacity:0;transition:opacity .3s}
#reticle svg{width:100%;height:100%}
</style>
</head>
<body>
<video id="video" playsinline autoplay muted></video>
<canvas id="three-canvas"></canvas>
<canvas id="hand-canvas"></canvas>
<div id="reticle"><svg viewBox="0 0 40 40" fill="none"><circle cx="20" cy="20" r="8" stroke="#00eeff" stroke-width="1" opacity=".7"/><line x1="20" y1="2" x2="20" y2="12" stroke="#00eeff" stroke-width="1" opacity=".7"/><line x1="20" y1="28" x2="20" y2="38" stroke="#00eeff" stroke-width="1" opacity=".7"/><line x1="2" y1="20" x2="12" y2="20" stroke="#00eeff" stroke-width="1" opacity=".7"/><line x1="28" y1="20" x2="38" y2="20" stroke="#00eeff" stroke-width="1" opacity=".7"/></svg></div>
<div id="gflash"><div id="gflash-text"></div></div>
<div id="hud">
  <div class="crn tl"></div><div class="crn tr"></div><div class="crn bl"></div><div class="crn br"></div>
  <div id="topbar">
    <div id="logo">AR <span>Â·</span> SOLAR SYSTEM <span>Â·</span> UNIVERSE</div>
    <div id="pills">
      <div class="pill warn" id="cam-pill"><div class="dot"></div>CAMERA OFF</div>
      <div class="pill" id="hand-pill"><div class="dot"></div>HANDS: STANDBY</div>
      <div class="pill on" id="sys-pill"><div class="dot"></div>SYSTEM ONLINE</div>
    </div>
  </div>
  <div id="gestures">
    <div class="gst" id="g-pinch"><span class="gi">ğŸ¤Œ</span>PINCH â€” ZOOM</div>
    <div class="gst" id="g-grab"><span class="gi">âœŠ</span>FIST â€” ROTATE</div>
    <div class="gst" id="g-point"><span class="gi">â˜ï¸</span>POINT â€” SELECT</div>
    <div class="gst" id="g-open"><span class="gi">ğŸ–ï¸</span>OPEN â€” TILT</div>
    <div class="gst" id="g-swipe"><span class="gi">ğŸ‘‹</span>SWIPE â€” NEXT PLANET</div>
  </div>
  <div id="pinfo">
    <div class="pname" id="pname">â€”</div>
    <div class="prow">Diameter <span id="p-dia">â€”</span></div>
    <div class="prow">Dist. from Sun <span id="p-dist">â€”</span></div>
    <div class="prow">Orbital Period <span id="p-orb">â€”</span></div>
    <div class="prow">Rotation <span id="p-rot">â€”</span></div>
    <div class="prow">Moons <span id="p-moons">â€”</span></div>
    <div class="prow">Avg Temp <span id="p-temp">â€”</span></div>
  </div>
  <div id="btmbar">
    <div id="controls">
      <button class="btn on" onclick="toggleAR()" id="btn-ar">â¬¤ AR MODE</button>
      <button class="btn on" onclick="toggleOrbits()" id="btn-orbits">â—¯ ORBITS</button>
      <button class="btn on" onclick="toggleLabels()" id="btn-labels">âŸ LABELS</button>
      <button class="btn" onclick="togglePause()" id="btn-pause">â¸ PAUSE</button>
      <button class="btn" onclick="resetCamera()">âŒ– RESET</button>
      <button class="btn" onclick="toggleSpeed()" id="btn-speed">âš¡ Ã—1</button>
    </div>
    <div id="cam-tip">DRAG TO ROTATE Â· SCROLL TO ZOOM Â· CLICK PLANET TO SELECT</div>
  </div>
</div>
<div id="splash">
  <h1>SOLAR SYSTEM</h1>
  <p>AUGMENTED REALITY Â· GESTURE CONTROL Â· 3D UNIVERSE</p>
  <div id="progress-bar"><div id="progress-fill"></div></div>
  <p id="splash-status" style="font-size:10px;letter-spacing:.2em;color:rgba(0,238,255,.5)">INITIALIZING...</p>
  <button id="allow-cam" onclick="initCamera()">â¬¤ ENABLE CAMERA & LAUNCH</button>
  <button id="skip-cam" onclick="skipCamera()">LAUNCH WITHOUT CAMERA</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
// â”€â”€ SEEDED RNG for consistent textures â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function seededRandom(seed){
  let s=seed;
  return function(){s=Math.sin(s)*10000;return s-Math.floor(s);};
}

// â”€â”€ PLANET DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PLANETS=[
  {name:'Mercury',radius:.18,dist:5,speed:4.15,tilt:.03,seed:1,
   info:{dia:'4,879 km',dist:'57.9M km',orb:'88 days',rot:'58.6 days',moons:'0',temp:'167Â°C'}},
  {name:'Venus',radius:.44,dist:7.2,speed:1.62,tilt:177.4,seed:2,
   info:{dia:'12,104 km',dist:'108.2M km',orb:'225 days',rot:'243 days',moons:'0',temp:'464Â°C'}},
  {name:'Earth',radius:.46,dist:10,speed:1.0,tilt:23.4,seed:3,
   info:{dia:'12,742 km',dist:'149.6M km',orb:'365 days',rot:'24 hrs',moons:'1',temp:'15Â°C'}},
  {name:'Mars',radius:.26,dist:14,speed:.53,tilt:25.2,seed:4,
   info:{dia:'6,779 km',dist:'227.9M km',orb:'687 days',rot:'24.6 hrs',moons:'2',temp:'-65Â°C'}},
  {name:'Jupiter',radius:1.2,dist:20,speed:.084,tilt:3.1,seed:5,
   info:{dia:'139,820 km',dist:'778.5M km',orb:'11.9 yrs',rot:'10 hrs',moons:'95',temp:'-110Â°C'}},
  {name:'Saturn',radius:1.0,dist:28,speed:.034,tilt:26.7,seed:6,
   info:{dia:'116,460 km',dist:'1.43B km',orb:'29.5 yrs',rot:'10.7 hrs',moons:'146',temp:'-140Â°C'}},
  {name:'Uranus',radius:.7,dist:35,speed:.012,tilt:97.8,seed:7,
   info:{dia:'50,724 km',dist:'2.87B km',orb:'84 yrs',rot:'17.2 hrs',moons:'27',temp:'-195Â°C'}},
  {name:'Neptune',radius:.68,dist:42,speed:.006,tilt:28.3,seed:8,
   info:{dia:'49,244 km',dist:'4.5B km',orb:'165 yrs',rot:'16.1 hrs',moons:'16',temp:'-200Â°C'}}
];

// â”€â”€ TEXTURE GENERATORS (photorealistic procedural) â”€â”€â”€â”€â”€â”€â”€â”€

function mkMercuryTex(){
  const sz=512,c=document.createElement('canvas');c.width=sz;c.height=sz;
  const x=c.getContext('2d');const rng=seededRandom(101);
  // Base dark grey-brown
  const bg=x.createRadialGradient(sz*.45,sz*.4,0,sz*.5,sz*.5,sz*.7);
  bg.addColorStop(0,'#9e8d82');bg.addColorStop(.5,'#7a6960');bg.addColorStop(1,'#4a3d36');
  x.fillStyle=bg;x.fillRect(0,0,sz,sz);
  // Craters - many overlapping
  for(let i=0;i<120;i++){
    const cx2=rng()*sz,cy2=rng()*sz,r=(2+rng()*30);
    x.beginPath();x.arc(cx2,cy2,r,0,Math.PI*2);
    x.fillStyle=`rgba(${40+rng()*30},${34+rng()*25},${30+rng()*20},0.6)`;x.fill();
    // Crater rim highlight
    x.beginPath();x.arc(cx2-r*.2,cy2-r*.2,r*.9,0,Math.PI*2);
    x.strokeStyle=`rgba(180,160,140,${0.1+rng()*.15})`;x.lineWidth=1+rng()*2;x.stroke();
    // Central peak for big craters
    if(r>15){x.beginPath();x.arc(cx2,cy2,r*.15,0,Math.PI*2);x.fillStyle='rgba(160,140,120,0.4)';x.fill();}
  }
  // Surface texture noise
  x.globalAlpha=.25;
  for(let i=0;i<3000;i++){
    const px=rng()*sz,py=rng()*sz,s=1+rng()*3;
    x.fillStyle=rng()>.5?'rgba(255,240,220,.3)':'rgba(0,0,0,.4)';
    x.fillRect(px,py,s,s);
  }
  x.globalAlpha=1;
  // Bright ray system from large impact
  x.globalAlpha=.07;
  const rcx=sz*.35,rcy=sz*.28;
  for(let i=0;i<12;i++){
    const angle=rng()*Math.PI*2,len=rng()*sz*.4;
    x.beginPath();x.moveTo(rcx,rcy);x.lineTo(rcx+Math.cos(angle)*len,rcy+Math.sin(angle)*len);
    x.strokeStyle='#c8b8a8';x.lineWidth=2+rng()*3;x.stroke();
  }
  x.globalAlpha=1;
  return new THREE.CanvasTexture(c);
}

function mkVenusTex(){
  const sz=512,c=document.createElement('canvas');c.width=sz;c.height=sz;
  const x=c.getContext('2d');const rng=seededRandom(202);
  // Base thick cloud layer, orange-yellow
  x.fillStyle='#d4a84b';x.fillRect(0,0,sz,sz);
  // Swirling cloud bands
  for(let i=0;i<25;i++){
    const y=rng()*sz,h=20+rng()*60;
    const g=x.createLinearGradient(0,y,0,y+h);
    const r=Math.floor(200+rng()*55),gr=Math.floor(140+rng()*60),b=Math.floor(40+rng()*40);
    g.addColorStop(0,`rgba(${r},${gr},${b},0)`);
    g.addColorStop(.3,`rgba(${r},${gr},${b},${.3+rng()*.4})`);
    g.addColorStop(.7,`rgba(${r},${gr},${b},${.2+rng()*.3})`);
    g.addColorStop(1,`rgba(${r},${gr},${b},0)`);
    x.fillStyle=g;x.fillRect(0,y,sz,h);
  }
  // Swirl vortices
  for(let i=0;i<15;i++){
    const cx2=rng()*sz,cy2=rng()*sz,r=30+rng()*80;
    const g=x.createRadialGradient(cx2,cy2,0,cx2,cy2,r);
    g.addColorStop(0,`rgba(255,200,100,${.3+rng()*.2})`);
    g.addColorStop(.5,`rgba(200,130,60,${.1+rng()*.15})`);
    g.addColorStop(1,'rgba(0,0,0,0)');
    x.fillStyle=g;x.beginPath();x.ellipse(cx2,cy2,r,r*.4,rng()*Math.PI,0,Math.PI*2);x.fill();
  }
  // Sulphuric haze streaks
  x.globalAlpha=.15;
  for(let i=0;i<200;i++){
    x.fillStyle='rgba(255,220,100,.5)';
    x.fillRect(rng()*sz,rng()*sz,rng()*80,1+rng()*2);
  }
  x.globalAlpha=1;
  return new THREE.CanvasTexture(c);
}

function mkEarthTex(){
  const sz=512,c=document.createElement('canvas');c.width=sz;c.height=sz;
  const x=c.getContext('2d');const rng=seededRandom(303);
  // Deep ocean
  x.fillStyle='#0d3a6b';x.fillRect(0,0,sz,sz);
  // Ocean depth variation
  const og=x.createLinearGradient(0,0,sz,sz);
  og.addColorStop(0,'rgba(0,40,100,.5)');og.addColorStop(.5,'rgba(0,20,60,.3)');og.addColorStop(1,'rgba(10,50,110,.4)');
  x.fillStyle=og;x.fillRect(0,0,sz,sz);

  // Continents - shaped like real landmasses
  const continents=[
    // North America
    {pts:[[.15,.2],[.28,.18],[.35,.25],[.32,.38],[.25,.42],[.18,.48],[.12,.44],[.08,.35],[.10,.25]],col:'#5a7a35'},
    // South America
    {pts:[[.22,.48],[.28,.46],[.32,.52],[.30,.62],[.26,.70],[.20,.68],[.18,.58],[.20,.50]],col:'#4a6a28'},
    // Europe + Asia (simplified blob)
    {pts:[[.48,.18],[.62,.15],[.78,.18],[.90,.22],[.95,.30],[.92,.38],[.82,.42],[.70,.45],[.60,.40],[.52,.35],[.46,.28]],col:'#6a8040'},
    // Africa
    {pts:[[.50,.35],[.60,.33],[.66,.40],[.64,.55],[.60,.65],[.52,.68],[.46,.60],[.44,.48],[.46,.38]],col:'#8a7a3a'},
    // Australia
    {pts:[[.75,.55],[.85,.54],[.90,.60],[.88,.68],[.80,.70],[.74,.65],[.72,.58]],col:'#9a8040'},
    // Antarctica
    {pts:[[.0,.88],[.25,.86],[.5,.85],[.75,.86],[1.0,.88],[1.0,1],[0,1]],col:'#ddeeff'},
    // Greenland
    {pts:[[.22,.12],[.30,.10],[.34,.16],[.32,.22],[.26,.24],[.20,.20]],col:'#cce0ee'},
  ];
  continents.forEach(({pts,col})=>{
    x.beginPath();
    x.moveTo(pts[0][0]*sz,pts[0][1]*sz);
    pts.forEach(p=>x.lineTo(p[0]*sz,p[1]*sz));
    x.closePath();
    // Add noise to continent edges
    x.fillStyle=col;x.fill();
    // Shading
    const shade=x.createLinearGradient(0,0,sz*.3,sz*.3);
    shade.addColorStop(0,'rgba(255,255,255,.05)');shade.addColorStop(1,'rgba(0,0,0,.15)');
    x.fillStyle=shade;x.fill();
  });

  // Mountain snow caps
  x.globalAlpha=.4;
  [[.20,.30],[.22,.20],[.50,.20],[.52,.25],[.75,.22]].forEach(([px,py])=>{
    const g=x.createRadialGradient(px*sz,py*sz,0,px*sz,py*sz,sz*.03);
    g.addColorStop(0,'rgba(255,255,255,.7)');g.addColorStop(1,'transparent');
    x.fillStyle=g;x.beginPath();x.arc(px*sz,py*sz,sz*.03,0,Math.PI*2);x.fill();
  });

  // Polar ice caps
  x.globalAlpha=1;
  const iN=x.createLinearGradient(0,0,0,sz*.13);
  iN.addColorStop(0,'#e8f4ff');iN.addColorStop(.7,'rgba(220,240,255,.7)');iN.addColorStop(1,'transparent');
  x.fillStyle=iN;x.fillRect(0,0,sz,sz*.12);
  const iS=x.createLinearGradient(0,sz*.87,0,sz);
  iS.addColorStop(0,'transparent');iS.addColorStop(.3,'rgba(220,240,255,.8)');iS.addColorStop(1,'#e8f4ff');
  x.fillStyle=iS;x.fillRect(0,sz*.88,sz,sz*.12);

  // Cloud layer
  x.globalAlpha=.45;
  for(let i=0;i<35;i++){
    const px=rng()*sz,py=rng()*sz,r=20+rng()*70,stretch=1+rng()*2;
    const g=x.createRadialGradient(px,py,0,px,py,r);
    g.addColorStop(0,'rgba(255,255,255,.8)');g.addColorStop(.5,'rgba(255,255,255,.3)');g.addColorStop(1,'transparent');
    x.fillStyle=g;x.save();x.scale(stretch,1);x.beginPath();x.arc(px/stretch,py,r,0,Math.PI*2);x.fill();x.restore();
  }
  // Horizontal cloud bands
  for(let i=0;i<5;i++){
    const y=rng()*sz;
    const g=x.createLinearGradient(0,y-8,0,y+8);
    g.addColorStop(0,'transparent');g.addColorStop(.5,'rgba(255,255,255,.2)');g.addColorStop(1,'transparent');
    x.fillStyle=g;x.fillRect(0,y-8,sz,16);
  }
  x.globalAlpha=1;
  return new THREE.CanvasTexture(c);
}

function mkMarsTex(){
  const sz=512,c=document.createElement('canvas');c.width=sz;c.height=sz;
  const x=c.getContext('2d');const rng=seededRandom(404);
  // Rusty red-orange base
  const bg=x.createLinearGradient(0,0,sz,sz);
  bg.addColorStop(0,'#c1440e');bg.addColorStop(.4,'#a0330a');bg.addColorStop(.7,'#c85020');bg.addColorStop(1,'#8a2800');
  x.fillStyle=bg;x.fillRect(0,0,sz,sz);

  // Valles Marineris - giant canyon system
  x.globalAlpha=.7;
  const canyon=x.createLinearGradient(0,sz*.4,0,sz*.55);
  canyon.addColorStop(0,'rgba(60,15,0,.0)');canyon.addColorStop(.3,'rgba(40,8,0,.8)');canyon.addColorStop(.7,'rgba(40,8,0,.6)');canyon.addColorStop(1,'rgba(60,15,0,.0)');
  x.fillStyle=canyon;x.save();x.transform(1,0,-.3,1,sz*.3,0);x.fillRect(0,sz*.42,sz*.55,sz*.1);x.restore();

  // Polar ice caps
  x.globalAlpha=.85;
  const mN=x.createRadialGradient(sz*.5,0,0,sz*.5,0,sz*.18);
  mN.addColorStop(0,'#ffe8d8');mN.addColorStop(.6,'rgba(255,220,200,.7)');mN.addColorStop(1,'transparent');
  x.fillStyle=mN;x.fillRect(0,0,sz,sz*.15);
  const mS=x.createRadialGradient(sz*.5,sz,0,sz*.5,sz,sz*.12);
  mS.addColorStop(0,'#ffe8d8');mS.addColorStop(.6,'rgba(255,220,200,.5)');mS.addColorStop(1,'transparent');
  x.fillStyle=mS;x.fillRect(0,sz*.88,sz,sz*.12);

  // Craters
  x.globalAlpha=.6;
  for(let i=0;i<80;i++){
    const cx2=rng()*sz,cy2=rng()*sz,r=2+rng()*22;
    // Dark interior
    const g=x.createRadialGradient(cx2,cy2,0,cx2,cy2,r);
    g.addColorStop(0,'rgba(50,12,2,.7)');g.addColorStop(.7,'rgba(70,20,5,.4)');g.addColorStop(1,'rgba(0,0,0,0)');
    x.fillStyle=g;x.beginPath();x.arc(cx2,cy2,r,0,Math.PI*2);x.fill();
    // Rim
    x.beginPath();x.arc(cx2,cy2,r,0,Math.PI*2);
    x.strokeStyle=`rgba(200,120,60,${.15+rng()*.2})`;x.lineWidth=1.5;x.stroke();
  }

  // Dust storm swirls
  x.globalAlpha=.15;
  for(let i=0;i<20;i++){
    const cx2=rng()*sz,cy2=rng()*sz,r=40+rng()*100;
    const g=x.createRadialGradient(cx2,cy2,0,cx2,cy2,r);
    g.addColorStop(0,'rgba(220,160,80,.5)');g.addColorStop(1,'transparent');
    x.fillStyle=g;x.beginPath();x.ellipse(cx2,cy2,r,r*.3,rng()*Math.PI,0,Math.PI*2);x.fill();
  }

  // Surface texture
  x.globalAlpha=.2;
  for(let i=0;i<2000;i++){
    x.fillStyle=rng()>.5?'rgba(200,100,40,.3)':'rgba(80,20,0,.4)';
    x.fillRect(rng()*sz,rng()*sz,1+rng()*3,1+rng()*2);
  }
  x.globalAlpha=1;
  return new THREE.CanvasTexture(c);
}

function mkJupiterTex(){
  const sz=512,c=document.createElement('canvas');c.width=sz;c.height=sz;
  const x=c.getContext('2d');const rng=seededRandom(505);

  // Base tan/orange
  x.fillStyle='#c88b3a';x.fillRect(0,0,sz,sz);

  // Cloud bands - horizontal stripes with color variation
  const bands=[
    {y:.0,h:.06,col:'#e8c878',op:.9},
    {y:.06,h:.05,col:'#a06030',op:.85},
    {y:.11,h:.04,col:'#d4a060',op:.9},
    {y:.15,h:.06,col:'#8a4820',op:.8},
    {y:.21,h:.03,col:'#e0b870',op:.9},
    {y:.24,h:.07,col:'#b87040',op:.85},
    {y:.31,h:.04,col:'#f0d090',op:.9},
    {y:.35,h:.06,col:'#904020',op:.8},
    {y:.41,h:.05,col:'#d09050',op:.9},
    {y:.46,h:.08,col:'#b06838',op:.85},
    {y:.54,h:.04,col:'#e8c870',op:.9},
    {y:.58,h:.06,col:'#984828',op:.8},
    {y:.64,h:.05,col:'#d4a060',op:.9},
    {y:.69,h:.07,col:'#c08040',op:.85},
    {y:.76,h:.04,col:'#e0c880',op:.9},
    {y:.80,h:.06,col:'#a05830',op:.85},
    {y:.86,h:.07,col:'#d4a860',op:.9},
    {y:.93,h:.07,col:'#b87040',op:.85},
  ];
  bands.forEach(b=>{
    // Wavy band
    x.beginPath();
    x.moveTo(0,b.y*sz);
    for(let i=0;i<=sz;i+=8){
      const wave=Math.sin(i*.04+rng()*2)*4+Math.sin(i*.02)*6;
      x.lineTo(i,(b.y*sz)+wave);
    }
    x.lineTo(sz,(b.y+b.h)*sz);
    for(let i=sz;i>=0;i-=8){
      const wave=Math.sin(i*.04+rng()*2)*4+Math.sin(i*.02)*6;
      x.lineTo(i,((b.y+b.h)*sz)+wave);
    }
    x.closePath();
    x.fillStyle=b.col;x.globalAlpha=b.op;x.fill();
  });

  // Storm swirls / turbulence
  x.globalAlpha=.3;
  for(let i=0;i<30;i++){
    const cx2=rng()*sz,cy2=rng()*sz,r=15+rng()*40;
    const g=x.createRadialGradient(cx2,cy2,0,cx2,cy2,r);
    g.addColorStop(0,'rgba(255,220,150,.4)');g.addColorStop(.5,'rgba(180,100,40,.2)');g.addColorStop(1,'transparent');
    x.fillStyle=g;x.beginPath();x.ellipse(cx2,cy2,r,r*.35,rng()*Math.PI,0,Math.PI*2);x.fill();
  }

  // Great Red Spot - iconic
  x.globalAlpha=1;
  const grsX=sz*.38,grsY=sz*.54,grsRX=sz*.1,grsRY=sz*.065;
  // Outer ring
  const grs=x.createRadialGradient(grsX,grsY,0,grsX,grsY,grsRX);
  grs.addColorStop(0,'#8a1808');grs.addColorStop(.4,'#c02820');grs.addColorStop(.7,'#c84030');grs.addColorStop(.85,'rgba(180,80,40,.5)');grs.addColorStop(1,'transparent');
  x.fillStyle=grs;x.beginPath();x.ellipse(grsX,grsY,grsRX*1.3,grsRY*1.3,0,0,Math.PI*2);x.fill();
  // Inner swirl
  for(let ring=0;ring<4;ring++){
    const r2=(1-ring/4)*grsRX,op=.2+ring*.1;
    x.beginPath();x.ellipse(grsX+(ring%2?3:-3),grsY,r2,r2*.6,0,0,Math.PI*2);
    x.strokeStyle=`rgba(200,80,30,${op})`;x.lineWidth=2+ring;x.stroke();
  }

  x.globalAlpha=1;
  return new THREE.CanvasTexture(c);
}

function mkSaturnTex(){
  const sz=512,c=document.createElement('canvas');c.width=sz;c.height=sz;
  const x=c.getContext('2d');const rng=seededRandom(606);

  // Base golden yellow
  x.fillStyle='#e8d090';x.fillRect(0,0,sz,sz);

  // Bands - softer than Jupiter
  const bands=[
    {y:.0,h:.08,col:'#f0dca0',op:.9},
    {y:.08,h:.05,col:'#c8a860',op:.8},
    {y:.13,h:.06,col:'#e4d090',op:.85},
    {y:.19,h:.04,col:'#b89040',op:.8},
    {y:.23,h:.08,col:'#f0dca0',op:.9},
    {y:.31,h:.05,col:'#d4b060',op:.85},
    {y:.36,h:.06,col:'#ecdca8',op:.9},
    {y:.42,h:.05,col:'#c09048',op:.8},
    {y:.47,h:.08,col:'#f0d898',op:.9},
    {y:.55,h:.05,col:'#b88838',op:.8},
    {y:.60,h:.07,col:'#e8d490',op:.85},
    {y:.67,h:.05,col:'#c8a858',op:.8},
    {y:.72,h:.08,col:'#f0dca0',op:.9},
    {y:.80,h:.05,col:'#d4b468',op:.85},
    {y:.85,h:.08,col:'#ecdca8',op:.9},
    {y:.93,h:.07,col:'#c8a860',op:.85},
  ];
  bands.forEach(b=>{
    x.beginPath();x.moveTo(0,b.y*sz);
    for(let i=0;i<=sz;i+=10){
      const wave=Math.sin(i*.03+rng())*3;
      x.lineTo(i,(b.y*sz)+wave);
    }
    x.lineTo(sz,(b.y+b.h)*sz);
    for(let i=sz;i>=0;i-=10){
      const wave=Math.sin(i*.03+rng())*3;
      x.lineTo(i,((b.y+b.h)*sz)+wave);
    }
    x.closePath();x.fillStyle=b.col;x.globalAlpha=b.op;x.fill();
  });

  // Storm oval (north hemisphere)
  x.globalAlpha=.8;
  const sx2=sz*.6,sy2=sz*.3;
  const sg=x.createRadialGradient(sx2,sy2,0,sx2,sy2,sz*.06);
  sg.addColorStop(0,'rgba(255,245,220,.6)');sg.addColorStop(.5,'rgba(240,220,160,.3)');sg.addColorStop(1,'transparent');
  x.fillStyle=sg;x.beginPath();x.ellipse(sx2,sy2,sz*.07,sz*.03,0,0,Math.PI*2);x.fill();

  x.globalAlpha=1;
  return new THREE.CanvasTexture(c);
}

function mkUranusTex(){
  const sz=512,c=document.createElement('canvas');c.width=sz;c.height=sz;
  const x=c.getContext('2d');const rng=seededRandom(707);

  // Cyan-blue-green ice giant
  const bg=x.createLinearGradient(0,0,0,sz);
  bg.addColorStop(0,'#7de8e8');bg.addColorStop(.3,'#60d0d8');bg.addColorStop(.6,'#90f0f0');bg.addColorStop(1,'#5ac0cc');
  x.fillStyle=bg;x.fillRect(0,0,sz,sz);

  // Subtle banding
  for(let i=0;i<8;i++){
    const y=rng()*sz,h=15+rng()*40;
    const g=x.createLinearGradient(0,y,0,y+h);
    const cr=Math.floor(80+rng()*40),cg=Math.floor(220+rng()*35),cb=Math.floor(220+rng()*35);
    g.addColorStop(0,`rgba(${cr},${cg},${cb},0)`);
    g.addColorStop(.5,`rgba(${cr},${cg},${cb},${.1+rng()*.15})`);
    g.addColorStop(1,`rgba(${cr},${cg},${cb},0)`);
    x.fillStyle=g;x.globalAlpha=.6;x.fillRect(0,y,sz,h);
  }

  // Methane haze - smooth gradient overlays
  x.globalAlpha=.25;
  for(let i=0;i<15;i++){
    const cx2=rng()*sz,cy2=rng()*sz,r=40+rng()*80;
    const g=x.createRadialGradient(cx2,cy2,0,cx2,cy2,r);
    g.addColorStop(0,'rgba(180,255,255,.3)');g.addColorStop(1,'transparent');
    x.fillStyle=g;x.beginPath();x.arc(cx2,cy2,r,0,Math.PI*2);x.fill();
  }
  x.globalAlpha=1;
  return new THREE.CanvasTexture(c);
}

function mkNeptuneTex(){
  const sz=512,c=document.createElement('canvas');c.width=sz;c.height=sz;
  const x=c.getContext('2d');const rng=seededRandom(808);

  // Deep vibrant blue
  const bg=x.createLinearGradient(0,0,sz,sz);
  bg.addColorStop(0,'#1030a8');bg.addColorStop(.4,'#2050d8');bg.addColorStop(.7,'#1840c0');bg.addColorStop(1,'#0820a0');
  x.fillStyle=bg;x.fillRect(0,0,sz,sz);

  // Bands
  for(let i=0;i<12;i++){
    const y=rng()*sz,h=20+rng()*50;
    const g=x.createLinearGradient(0,y,0,y+h);
    const shade=Math.floor(20+rng()*40),shade2=Math.floor(80+rng()*80);
    g.addColorStop(0,`rgba(${shade},${shade+shade2},255,0)`);
    g.addColorStop(.5,`rgba(${shade},${shade+shade2},255,${.15+rng()*.2})`);
    g.addColorStop(1,`rgba(${shade},${shade+shade2},255,0)`);
    x.fillStyle=g;x.globalAlpha=.7;x.fillRect(0,y,sz,h);
  }

  // Great Dark Spot
  x.globalAlpha=.85;
  const dsX=sz*.4,dsY=sz*.38;
  const ds=x.createRadialGradient(dsX,dsY,0,dsX,dsY,sz*.09);
  ds.addColorStop(0,'rgba(0,8,40,.9)');ds.addColorStop(.5,'rgba(0,15,60,.6)');ds.addColorStop(1,'transparent');
  x.fillStyle=ds;x.beginPath();x.ellipse(dsX,dsY,sz*.1,sz*.065,-.3,0,Math.PI*2);x.fill();

  // Small bright storm scooter
  x.globalAlpha=.7;
  const sc=x.createRadialGradient(sz*.7,sz*.55,0,sz*.7,sz*.55,sz*.04);
  sc.addColorStop(0,'rgba(180,220,255,.8)');sc.addColorStop(1,'transparent');
  x.fillStyle=sc;x.beginPath();x.arc(sz*.7,sz*.55,sz*.04,0,Math.PI*2);x.fill();

  // Cloud streaks
  x.globalAlpha=.2;
  for(let i=0;i<20;i++){
    x.fillStyle='rgba(150,200,255,.4)';
    x.fillRect(rng()*sz,rng()*sz,rng()*100,1+rng()*2);
  }
  x.globalAlpha=1;
  return new THREE.CanvasTexture(c);
}

function mkSunTex(){
  const sz=512,c=document.createElement('canvas');c.width=sz;c.height=sz;
  const x=c.getContext('2d');const rng=seededRandom(99);
  // Core radial gradient
  const sg=x.createRadialGradient(sz*.5,sz*.5,0,sz*.5,sz*.5,sz*.5);
  sg.addColorStop(0,'#ffffff');sg.addColorStop(.06,'#fff8e0');sg.addColorStop(.2,'#ffec60');sg.addColorStop(.45,'#ffaa00');sg.addColorStop(.7,'#ff6600');sg.addColorStop(.9,'#cc3300');sg.addColorStop(1,'#aa2200');
  x.fillStyle=sg;x.fillRect(0,0,sz,sz);

  // Solar granulation cells
  x.globalAlpha=.35;
  for(let i=0;i<200;i++){
    const px=rng()*sz,py=rng()*sz,r=5+rng()*25;
    const g=x.createRadialGradient(px,py,0,px,py,r);
    g.addColorStop(0,'rgba(255,255,200,.6)');g.addColorStop(.6,'rgba(255,200,50,.2)');g.addColorStop(1,'transparent');
    x.fillStyle=g;x.beginPath();x.arc(px,py,r,0,Math.PI*2);x.fill();
  }
  // Sunspots
  x.globalAlpha=.6;
  [[.38,.45],[.55,.35],[.62,.60],[.30,.58]].forEach(([px,py])=>{
    const r=8+rng()*15;
    const g=x.createRadialGradient(px*sz,py*sz,0,px*sz,py*sz,r);
    g.addColorStop(0,'rgba(80,20,0,.8)');g.addColorStop(.5,'rgba(120,40,0,.4)');g.addColorStop(1,'transparent');
    x.fillStyle=g;x.beginPath();x.arc(px*sz,py*sz,r,0,Math.PI*2);x.fill();
  });
  // Solar flare wisps
  x.globalAlpha=.15;
  for(let i=0;i<8;i++){
    const angle=rng()*Math.PI*2,len=sz*.2+rng()*sz*.15;
    x.beginPath();x.moveTo(sz*.5,sz*.5);x.quadraticCurveTo(sz*.5+Math.cos(angle+.5)*len*.5,sz*.5+Math.sin(angle+.5)*len*.5,sz*.5+Math.cos(angle)*len,sz*.5+Math.sin(angle)*len);
    x.strokeStyle='rgba(255,200,50,.5)';x.lineWidth=3+rng()*6;x.lineCap='round';x.stroke();
  }
  x.globalAlpha=1;
  return new THREE.CanvasTexture(c);
}

function mkMoonTex(){
  const sz=256,c=document.createElement('canvas');c.width=sz;c.height=sz;
  const x=c.getContext('2d');const rng=seededRandom(999);
  // Grey base
  x.fillStyle='#aaaaaa';x.fillRect(0,0,sz,sz);
  // Many craters
  for(let i=0;i<80;i++){
    const cx2=rng()*sz,cy2=rng()*sz,r=2+rng()*20;
    const g=x.createRadialGradient(cx2,cy2,0,cx2,cy2,r);
    g.addColorStop(0,'rgba(80,80,80,.7)');g.addColorStop(.7,'rgba(100,100,100,.3)');g.addColorStop(1,'rgba(0,0,0,0)');
    x.fillStyle=g;x.beginPath();x.arc(cx2,cy2,r,0,Math.PI*2);x.fill();
    // Rim
    x.beginPath();x.arc(cx2,cy2,r,0,Math.PI*2);x.strokeStyle='rgba(200,200,200,.2)';x.lineWidth=1;x.stroke();
  }
  // Texture noise
  x.globalAlpha=.15;
  for(let i=0;i<2000;i++){
    x.fillStyle=rng()>.5?'rgba(255,255,255,.3)':'rgba(0,0,0,.4)';
    x.fillRect(rng()*sz,rng()*sz,1+rng()*2,1+rng()*2);
  }
  x.globalAlpha=1;
  return new THREE.CanvasTexture(c);
}

const TEX_FNS=[mkMercuryTex,mkVenusTex,mkEarthTex,mkMarsTex,mkJupiterTex,mkSaturnTex,mkUranusTex,mkNeptuneTex];
const HAS_RINGS=[false,false,false,false,false,true,true,false];
const HAS_MOON=[false,false,true,false,false,false,false,false];
const ATM_COLORS=[null,0xffdd88,0x4488ff,null,null,null,0x44ddee,0x2244ff];
const ATM_OPS=[0,.18,.12,0,0,0,.12,.1];

// â”€â”€ THREE.JS SETUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const canvas3d=document.getElementById('three-canvas');
const renderer=new THREE.WebGLRenderer({canvas:canvas3d,antialias:true,alpha:true});
renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
renderer.setSize(window.innerWidth,window.innerHeight);
renderer.shadowMap.enabled=true;
renderer.shadowMap.type=THREE.PCFSoftShadowMap;

const scene=new THREE.Scene();
const camera=new THREE.PerspectiveCamera(60,window.innerWidth/window.innerHeight,.1,2000);
camera.position.set(0,22,58);

window.addEventListener('resize',()=>{
  renderer.setSize(window.innerWidth,window.innerHeight);
  camera.aspect=window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  hCanvas.width=window.innerWidth;hCanvas.height=window.innerHeight;
});

// â”€â”€ LIGHTING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
scene.add(new THREE.AmbientLight(0x111133,.4));
const sunLight=new THREE.PointLight(0xfff5e0,5,500);
sunLight.castShadow=true;
sunLight.shadow.mapSize.set(1024,1024);
scene.add(sunLight);
// Rim fill light
scene.add(Object.assign(new THREE.DirectionalLight(0x3366cc,.25),{position:new THREE.Vector3(-50,30,-50)}));
// Warm secondary fill
const fill2=new THREE.PointLight(0xff6600,.15,300);
fill2.position.set(0,0,0);scene.add(fill2);

// â”€â”€ SUN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const sunTex=mkSunTex();
const sunMesh=new THREE.Mesh(
  new THREE.SphereGeometry(2.8,64,64),
  new THREE.MeshBasicMaterial({map:sunTex})
);
scene.add(sunMesh);

// Sun glow
const glowC=document.createElement('canvas');glowC.width=256;glowC.height=256;
const glowX=glowC.getContext('2d');
const gg=glowX.createRadialGradient(128,128,0,128,128,128);
gg.addColorStop(0,'rgba(255,220,80,.7)');gg.addColorStop(.25,'rgba(255,150,0,.3)');gg.addColorStop(.6,'rgba(255,80,0,.08)');gg.addColorStop(1,'transparent');
glowX.fillStyle=gg;glowX.fillRect(0,0,256,256);
const sunGlow=new THREE.Sprite(new THREE.SpriteMaterial({map:new THREE.CanvasTexture(glowC),transparent:true,blending:THREE.AdditiveBlending}));
sunGlow.scale.set(22,22,1);scene.add(sunGlow);

[{r:3.3,op:.06},{r:4.8,op:.025}].forEach(({r,op})=>{
  scene.add(new THREE.Mesh(new THREE.SphereGeometry(r,32,32),
    new THREE.MeshBasicMaterial({color:0xff7700,transparent:true,opacity:op,side:THREE.BackSide,blending:THREE.AdditiveBlending})));
});

// â”€â”€ STARS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function mkStars(count,rMin,rMax,color,size){
  const g=new THREE.BufferGeometry(),v=[];
  for(let i=0;i<count;i++){const r=rMin+Math.random()*(rMax-rMin),t=Math.random()*Math.PI*2,p=Math.acos(2*Math.random()-1);v.push(r*Math.sin(p)*Math.cos(t),r*Math.sin(p)*Math.sin(t),r*Math.cos(p));}
  g.setAttribute('position',new THREE.Float32BufferAttribute(v,3));
  return new THREE.Points(g,new THREE.PointsMaterial({color,size,sizeAttenuation:true,transparent:true,opacity:.85}));
}
scene.add(mkStars(5000,200,900,0xffffff,.4));
scene.add(mkStars(600,180,400,0x6699ff,.75));
scene.add(mkStars(300,180,400,0xff4488,.75));
scene.add(mkStars(200,180,400,0xffdd66,.65));
scene.add(mkStars(150,180,400,0xff8844,.65));

// â”€â”€ LABEL SPRITE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function mkLabel(name){
  const c=document.createElement('canvas');c.width=256;c.height=56;
  const x=c.getContext('2d');
  x.font='bold 24px "Exo 2",sans-serif';
  x.fillStyle='rgba(0,238,255,.92)';x.textAlign='center';x.textBaseline='middle';
  x.shadowColor='#00eeff';x.shadowBlur=12;
  x.fillText(name.toUpperCase(),128,28);
  const s=new THREE.Sprite(new THREE.SpriteMaterial({map:new THREE.CanvasTexture(c),transparent:true}));
  s.scale.set(4,1,1);return s;
}

// â”€â”€ ORBIT LINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function mkOrbit(r){
  const pts=[];
  for(let i=0;i<=128;i++){const a=i/128*Math.PI*2;pts.push(new THREE.Vector3(Math.cos(a)*r,0,Math.sin(a)*r));}
  return new THREE.Line(new THREE.BufferGeometry().setFromPoints(pts),new THREE.LineBasicMaterial({color:0x00eeff,transparent:true,opacity:.12}));
}

// â”€â”€ SATURN RINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function mkSaturnRings(pd){
  const inner=pd.radius*1.3,outer=pd.radius*2.6;
  const geo=new THREE.RingGeometry(inner,outer,120,8);
  const pos=geo.attributes.position,uv=geo.attributes.uv;
  for(let i=0;i<pos.count;i++){
    const v=new THREE.Vector3().fromBufferAttribute(pos,i);
    const t=(v.length()-inner)/(outer-inner);
    uv.setXY(i,t,.5);
  }
  // Photorealistic Saturn ring canvas
  const rc=document.createElement('canvas');rc.width=512;rc.height=4;
  const rx=rc.getContext('2d');
  const rng=seededRandom(9001);
  const rg=rx.createLinearGradient(0,0,512,0);
  // A ring, B ring, C ring, Cassini division
  rg.addColorStop(0,'rgba(180,160,100,0)');
  rg.addColorStop(.04,'rgba(160,140,90,.5)');// C ring inner
  rg.addColorStop(.12,'rgba(180,160,100,.7)');// C ring
  rg.addColorStop(.20,'rgba(140,120,70,.3)');// Cassini division
  rg.addColorStop(.22,'rgba(100,80,40,.05)');// Division gap
  rg.addColorStop(.24,'rgba(140,120,70,.3)');
  rg.addColorStop(.28,'rgba(220,200,130,.95)');// B ring bright
  rg.addColorStop(.42,'rgba(240,220,150,1.0)');// B ring peak
  rg.addColorStop(.56,'rgba(210,190,120,.9)');// B ring outer
  rg.addColorStop(.60,'rgba(80,65,30,.08)');// Cassini division
  rg.addColorStop(.63,'rgba(200,175,110,.8)');// A ring inner
  rg.addColorStop(.75,'rgba(215,190,120,.85)');// A ring
  rg.addColorStop(.85,'rgba(180,155,95,.65)');// A ring outer
  rg.addColorStop(.92,'rgba(140,120,70,.3)');// F ring faint
  rg.addColorStop(1,'rgba(180,160,100,0)');
  rx.fillStyle=rg;rx.fillRect(0,0,512,4);
  // Add texture variation
  rx.globalAlpha=.15;
  for(let i=0;i<200;i++){
    const px=rng()*512;
    rx.fillStyle=rng()>.5?'rgba(255,240,180,.4)':'rgba(80,60,20,.3)';
    rx.fillRect(px,0,1+rng()*3,4);
  }
  const m=new THREE.Mesh(geo,new THREE.MeshBasicMaterial({map:new THREE.CanvasTexture(rc),transparent:true,side:THREE.DoubleSide,depthWrite:false}));
  m.rotation.x=Math.PI/2;return m;
}

// â”€â”€ URANUS RINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function mkUranusRings(pd){
  const inner=pd.radius*1.5,outer=pd.radius*2.0;
  const geo=new THREE.RingGeometry(inner,outer,80,3);
  const pos=geo.attributes.position,uv=geo.attributes.uv;
  for(let i=0;i<pos.count;i++){
    const v=new THREE.Vector3().fromBufferAttribute(pos,i);
    const t=(v.length()-inner)/(outer-inner);uv.setXY(i,t,.5);
  }
  const rc=document.createElement('canvas');rc.width=256;rc.height=2;
  const rx=rc.getContext('2d');
  const rg=rx.createLinearGradient(0,0,256,0);
  rg.addColorStop(0,'rgba(100,200,200,0)');rg.addColorStop(.3,'rgba(100,200,200,.3)');rg.addColorStop(.5,'rgba(80,180,180,.5)');rg.addColorStop(.7,'rgba(100,200,200,.3)');rg.addColorStop(1,'rgba(100,200,200,0)');
  rx.fillStyle=rg;rx.fillRect(0,0,256,2);
  const m=new THREE.Mesh(geo,new THREE.MeshBasicMaterial({map:new THREE.CanvasTexture(rc),transparent:true,side:THREE.DoubleSide,depthWrite:false}));
  m.rotation.x=Math.PI/2;return m;
}

// â”€â”€ BUILD PLANETS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const planetMeshes=[],orbitLines=[],labels=[];
let selectedPlanet=null,showOrbits=true,showLabels=true;

PLANETS.forEach((pd,i)=>{
  const tex=TEX_FNS[i]();
  
  let mat;
  if(pd.name==='Earth'){
    mat=new THREE.MeshStandardMaterial({map:tex,roughness:.6,metalness:0});
  }else if(pd.name==='Mercury'){
    mat=new THREE.MeshStandardMaterial({map:tex,roughness:.95,metalness:.15});
  }else if(pd.name==='Venus'){
    mat=new THREE.MeshStandardMaterial({map:tex,roughness:.85,metalness:0});
  }else if(pd.name==='Mars'){
    mat=new THREE.MeshStandardMaterial({map:tex,roughness:.9,metalness:0});
  }else if(pd.name==='Jupiter'||pd.name==='Saturn'){
    mat=new THREE.MeshStandardMaterial({map:tex,roughness:.75,metalness:0});
  }else{
    mat=new THREE.MeshStandardMaterial({map:tex,roughness:.8,metalness:0});
  }

  const mesh=new THREE.Mesh(new THREE.SphereGeometry(pd.radius,64,64),mat);
  mesh.castShadow=true;mesh.receiveShadow=true;
  mesh.rotation.z=THREE.MathUtils.degToRad(pd.tilt);
  mesh.userData={pd,angle:Math.random()*Math.PI*2};

  // Atmosphere glow
  if(ATM_COLORS[i]!==null){
    mesh.add(new THREE.Mesh(
      new THREE.SphereGeometry(pd.radius*1.07,32,32),
      new THREE.MeshBasicMaterial({color:ATM_COLORS[i],transparent:true,opacity:ATM_OPS[i],side:THREE.BackSide,blending:THREE.AdditiveBlending})
    ));
  }

  // Rings
  if(pd.name==='Saturn') mesh.add(mkSaturnRings(pd));
  else if(pd.name==='Uranus') mesh.add(mkUranusRings(pd));

  // Earth's Moon
  if(HAS_MOON[i]){
    const moon=new THREE.Mesh(
      new THREE.SphereGeometry(.12,32,32),
      new THREE.MeshStandardMaterial({map:mkMoonTex(),roughness:1})
    );
    moon.userData={isMoon:true,angle:Math.random()*Math.PI*2};
    mesh.add(moon);
  }

  const orb=mkOrbit(pd.dist);
  scene.add(orb);orbitLines.push(orb);

  const lbl=mkLabel(pd.name);
  lbl.position.y=pd.radius+1;
  mesh.add(lbl);labels.push(lbl);

  scene.add(mesh);planetMeshes.push(mesh);
});

// Asteroid belt
(()=>{
  const g=new THREE.BufferGeometry(),v=[];
  const rng=seededRandom(7777);
  for(let i=0;i<2000;i++){
    const r=16+rng()*3,a=rng()*Math.PI*2,h=(rng()-.5)*.5;
    v.push(Math.cos(a)*r,h,Math.sin(a)*r);
  }
  g.setAttribute('position',new THREE.Float32BufferAttribute(v,3));
  scene.add(new THREE.Points(g,new THREE.PointsMaterial({color:0x998877,size:.07,sizeAttenuation:true,transparent:true,opacity:.6})));
})();

// â”€â”€ HAND CANVAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const hCanvas=document.getElementById('hand-canvas');
const hCtx=hCanvas.getContext('2d');
hCanvas.width=window.innerWidth;hCanvas.height=window.innerHeight;

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let arMode=true,paused=false,speedMult=1;
let gesture='none';
let pinchDist0=null,pinchZ0=null;
let grabStartX=null,grabStartY=null,grabRot0=null,grabElev0=null;
let targetZ=58,camRot=0,camElev=.35;
let prevHandX=null,swipeCooldown=0;
const clock=new THREE.Clock();

// â”€â”€ CAMERA INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const video=document.getElementById('video');

async function initCamera(){
  const splash=document.getElementById('splash');
  setProgress(30,'REQUESTING CAMERA...');
  try{
    const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'user',width:{ideal:1280},height:{ideal:720}},audio:false});
    video.srcObject=stream;video.classList.add('on');await video.play();
    setProgress(60,'CAMERA ACTIVE...');
    document.getElementById('cam-pill').innerHTML='<div class="dot"></div>CAMERA ON';
    document.getElementById('cam-pill').className='pill on';
    // Load MediaPipe dynamically
    loadMediaPipe();
  }catch(e){
    console.warn('Camera:',e);
    document.getElementById('cam-pill').innerHTML='<div class="dot"></div>NO CAMERA';
    document.getElementById('cam-pill').className='pill warn';
  }
  setProgress(100,'LAUNCHING...');
  setTimeout(()=>splash.classList.add('gone'),800);
}

function skipCamera(){
  setProgress(100,'LAUNCHING...');
  setTimeout(()=>document.getElementById('splash').classList.add('gone'),600);
}

function setProgress(p,msg){
  document.getElementById('progress-fill').style.width=p+'%';
  document.getElementById('splash-status').textContent=msg;
}
setProgress(5,'LOADING THREE.JS...');
setTimeout(()=>setProgress(20,'GENERATING PLANET TEXTURES...'),100);
setTimeout(()=>setProgress(75,'BUILDING SOLAR SYSTEM...'),300);
setTimeout(()=>setProgress(95,'READY!'),600);

// â”€â”€ MEDIAPIPE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadMediaPipe(){
  const s1=document.createElement('script');
  s1.src='https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js';
  s1.crossOrigin='anonymous';
  document.head.appendChild(s1);
  const s2=document.createElement('script');
  s2.src='https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js';
  s2.crossOrigin='anonymous';
  s2.onload=initMediaPipe;
  document.head.appendChild(s2);
}

function initMediaPipe(){
  if(typeof Hands==='undefined'){console.warn('MediaPipe unavailable');return;}
  const hands=new Hands({locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
  hands.setOptions({maxNumHands:2,modelComplexity:1,minDetectionConfidence:.7,minTrackingConfidence:.6});
  hands.onResults(onHandResults);
  if(typeof Camera!=='undefined'){
    const cam=new Camera(video,{onFrame:async()=>await hands.send({image:video}),width:640,height:480});
    cam.start();
    document.getElementById('hand-pill').innerHTML='<div class="dot"></div>HANDS: ACTIVE';
    document.getElementById('hand-pill').className='pill on';
  }
}

const CONN=[[0,1],[1,2],[2,3],[3,4],[0,5],[5,6],[6,7],[7,8],[0,9],[9,10],[10,11],[11,12],[0,13],[13,14],[14,15],[15,16],[0,17],[17,18],[18,19],[19,20],[5,9],[9,13],[13,17]];
const TIPS=[4,8,12,16,20];
function d2(a,b){return Math.hypot(a.x-b.x,a.y-b.y);}

function detectGesture(lms){
  const tt=lms[4],it=lms[8],mt=lms[12],rt=lms[16],pt=lms[20];
  const im=lms[5],mm=lms[9],rm=lms[13],pm=lms[17];
  const pd=d2(tt,it);
  const iUp=it.y<im.y-.05,mUp=mt.y<mm.y-.05,rUp=rt.y<rm.y-.05,pUp=pt.y<pm.y-.05;
  if(pd<.06)return'pinch';
  if(!iUp&&!mUp&&!rUp&&!pUp)return'fist';
  if(iUp&&!mUp&&!rUp&&!pUp)return'point';
  if(iUp&&mUp&&rUp&&pUp)return'open';
  return'none';
}

function onHandResults(results){
  hCtx.clearRect(0,0,hCanvas.width,hCanvas.height);
  if(!results.multiHandLandmarks||!results.multiHandLandmarks.length){
    gesture='none';updateGestureUI();prevHandX=null;
    document.getElementById('reticle').style.opacity='0';return;
  }
  const W2=hCanvas.width,H2=hCanvas.height;
  const hands=results.multiHandLandmarks;
  hands.forEach(lms=>drawHand(lms,W2,H2));
  const lms=hands[0];
  gesture=detectGesture(lms);
  updateGestureUI();
  const it=lms[8],tt=lms[4],wr=lms[0];
  const rx=(1-it.x)*window.innerWidth,ry=it.y*window.innerHeight;
  const ret=document.getElementById('reticle');
  ret.style.left=rx+'px';ret.style.top=ry+'px';ret.style.opacity='1';
  if(gesture==='pinch'){
    if(hands.length>=2){
      const span=d2(lms[8],hands[1][8]);
      if(pinchDist0===null){pinchDist0=span;pinchZ0=targetZ;}
      else{targetZ=Math.max(6,Math.min(130,pinchZ0*(pinchDist0/Math.max(span,.01))));}
    }else{
      const pd2=d2(tt,it);
      if(pinchDist0===null){pinchDist0=pd2;pinchZ0=targetZ;}
      else{const delta=(pinchDist0-pd2)/Math.max(pinchDist0,.01);targetZ=Math.max(6,Math.min(130,pinchZ0+delta*90));}
    }
  }else{pinchDist0=null;}
  if(gesture==='fist'){
    if(grabStartX===null){grabStartX=wr.x;grabStartY=wr.y;grabRot0=camRot;grabElev0=camElev;}
    else{camRot=grabRot0+(grabStartX-wr.x)*5;camElev=grabElev0+(grabStartY-wr.y)*2.5;camElev=Math.max(-1.3,Math.min(1.3,camElev));}
  }else{grabStartX=null;grabStartY=null;}
  if(gesture==='open'){
    if(grabStartY===null){grabStartY=wr.y;grabElev0=camElev;}
    else{camElev=grabElev0+(grabStartY-wr.y)*3;camElev=Math.max(-1.3,Math.min(1.3,camElev));}
  }
  swipeCooldown=Math.max(0,swipeCooldown-1);
  if((gesture==='none'||gesture==='point')&&swipeCooldown===0){
    if(prevHandX!==null){
      const dx=wr.x-prevHandX;
      if(Math.abs(dx)>.14){
        const dir=dx>0?1:-1;
        const next=selectedPlanet!==null?(selectedPlanet+dir+PLANETS.length)%PLANETS.length:0;
        selectedPlanet=next;showPlanetInfo(next);swipeCooldown=35;
        flashGesture(PLANETS[next].name.toUpperCase());
      }
    }
    prevHandX=wr.x;
  }else if(gesture==='fist'||gesture==='open'){prevHandX=null;}
  if(gesture==='point'&&swipeCooldown===0){
    const nx=(1-it.x)*2-1,ny=-it.y*2+1;
    const ray=new THREE.Raycaster();ray.setFromCamera(new THREE.Vector2(nx,ny),camera);
    const hits=ray.intersectObjects(planetMeshes,false);
    if(hits.length>0){const idx=planetMeshes.indexOf(hits[0].object);if(idx>=0&&idx!==selectedPlanet){selectedPlanet=idx;showPlanetInfo(idx);flashGesture(PLANETS[idx].name.toUpperCase());}}
  }
}

function drawHand(lms,W2,H2){
  CONN.forEach(([a,b])=>{
    const pa=lms[a],pb=lms[b];
    hCtx.beginPath();hCtx.moveTo(pa.x*W2,pa.y*H2);hCtx.lineTo(pb.x*W2,pb.y*H2);
    hCtx.strokeStyle='rgba(0,238,255,.65)';hCtx.lineWidth=2;hCtx.stroke();
  });
  lms.forEach((lm,i)=>{
    const tip=TIPS.includes(i);
    hCtx.beginPath();hCtx.arc(lm.x*W2,lm.y*H2,tip?7:4,0,Math.PI*2);
    hCtx.fillStyle=tip?'rgba(0,238,255,1)':'rgba(0,238,255,.65)';hCtx.fill();
  });
}

function updateGestureUI(){
  const m={pinch:'g-pinch',fist:'g-grab',point:'g-point',open:'g-open'};
  document.querySelectorAll('.gst').forEach(e=>e.classList.remove('active'));
  if(m[gesture]){const el=document.getElementById(m[gesture]);if(el)el.classList.add('active');}
}

let flashTO=null;
function flashGesture(text){
  const el=document.getElementById('gflash'),tel=document.getElementById('gflash-text');
  tel.textContent=text;el.style.opacity='1';clearTimeout(flashTO);flashTO=setTimeout(()=>el.style.opacity='0',1200);
}

function showPlanetInfo(idx){
  const pd=PLANETS[idx];
  document.getElementById('pname').textContent=pd.name;
  document.getElementById('p-dia').textContent=pd.info.dia;
  document.getElementById('p-dist').textContent=pd.info.dist;
  document.getElementById('p-orb').textContent=pd.info.orb;
  document.getElementById('p-rot').textContent=pd.info.rot;
  document.getElementById('p-moons').textContent=pd.info.moons;
  document.getElementById('p-temp').textContent=pd.info.temp;
  document.getElementById('pinfo').classList.add('show');
}

// â”€â”€ CONTROLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleAR(){
  arMode=!arMode;
  video.style.opacity=arMode&&video.srcObject?'1':'0';
  document.getElementById('btn-ar').classList.toggle('on',arMode);
}
function toggleOrbits(){showOrbits=!showOrbits;orbitLines.forEach(o=>o.visible=showOrbits);document.getElementById('btn-orbits').classList.toggle('on',showOrbits);}
function toggleLabels(){showLabels=!showLabels;labels.forEach(l=>l.visible=showLabels);document.getElementById('btn-labels').classList.toggle('on',showLabels);}
function togglePause(){paused=!paused;document.getElementById('btn-pause').textContent=paused?'â–¶ RESUME':'â¸ PAUSE';document.getElementById('btn-pause').classList.toggle('on',paused);}
function resetCamera(){targetZ=58;camRot=0;camElev=.35;selectedPlanet=null;document.getElementById('pinfo').classList.remove('show');}
const SPEEDS=[1,5,25,100];let sIdx=0;
function toggleSpeed(){sIdx=(sIdx+1)%SPEEDS.length;speedMult=SPEEDS[sIdx];document.getElementById('btn-speed').textContent='âš¡ Ã—'+SPEEDS[sIdx];}

// â”€â”€ MOUSE / TOUCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let mDown=false,lmx=0,lmy=0;
canvas3d.style.pointerEvents='auto';
canvas3d.addEventListener('mousedown',e=>{if(e.button!==2){mDown=true;lmx=e.clientX;lmy=e.clientY;}});
window.addEventListener('mouseup',()=>mDown=false);
window.addEventListener('mousemove',e=>{
  if(!mDown)return;
  camRot-=(e.clientX-lmx)*.012;camElev+=(e.clientY-lmy)*.006;
  camElev=Math.max(-1.3,Math.min(1.3,camElev));lmx=e.clientX;lmy=e.clientY;
});
window.addEventListener('wheel',e=>{targetZ=Math.max(6,Math.min(130,targetZ+e.deltaY*.06));},{passive:true});
canvas3d.addEventListener('click',e=>{
  if(Math.abs(e.clientX-lmx)<3&&Math.abs(e.clientY-lmy)<3){
    const nx=(e.clientX/window.innerWidth)*2-1,ny=-(e.clientY/window.innerHeight)*2+1;
    const ray=new THREE.Raycaster();ray.setFromCamera(new THREE.Vector2(nx,ny),camera);
    const hits=ray.intersectObjects(planetMeshes,false);
    if(hits.length>0){const idx=planetMeshes.indexOf(hits[0].object);if(idx>=0){selectedPlanet=idx;showPlanetInfo(idx);flashGesture(PLANETS[idx].name.toUpperCase());}}
    else{selectedPlanet=null;document.getElementById('pinfo').classList.remove('show');}
  }
});
let tch0=null,tch1Span=null,tZ0=null;
window.addEventListener('touchstart',e=>{
  if(e.touches.length===1)tch0={x:e.touches[0].clientX,y:e.touches[0].clientY};
  if(e.touches.length===2){const dx=e.touches[0].clientX-e.touches[1].clientX,dy=e.touches[0].clientY-e.touches[1].clientY;tch1Span=Math.hypot(dx,dy);tZ0=targetZ;}
},{passive:true});
window.addEventListener('touchmove',e=>{
  if(e.touches.length===1&&tch0){camRot-=(e.touches[0].clientX-tch0.x)*.012;camElev+=(e.touches[0].clientY-tch0.y)*.006;camElev=Math.max(-1.3,Math.min(1.3,camElev));tch0={x:e.touches[0].clientX,y:e.touches[0].clientY};}
  if(e.touches.length===2&&tch1Span){const dx=e.touches[0].clientX-e.touches[1].clientX,dy=e.touches[0].clientY-e.touches[1].clientY;const span=Math.hypot(dx,dy);targetZ=Math.max(6,Math.min(130,tZ0*tch1Span/Math.max(span,1)));}
},{passive:true});

// â”€â”€ ANIMATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function animate(){
  requestAnimationFrame(animate);
  const dt=Math.min(clock.getDelta(),.05)*speedMult;

  if(!paused){
    sunMesh.rotation.y+=dt*.03;
    // Sun corona pulse
    const sp=.98+.02*Math.sin(Date.now()*.0015);
    sunGlow.scale.set(22*sp,22*sp,1);

    planetMeshes.forEach((mesh,i)=>{
      const pd=PLANETS[i];
      mesh.userData.angle+=dt*pd.speed*.1;
      mesh.position.x=Math.cos(mesh.userData.angle)*pd.dist;
      mesh.position.z=Math.sin(mesh.userData.angle)*pd.dist;
      mesh.rotation.y+=dt*(pd.name==='Venus'?-.22:.38);

      // Moon
      const moon=mesh.children.find(c=>c.userData&&c.userData.isMoon);
      if(moon){
        moon.userData.angle=(moon.userData.angle||0)+dt*2.2;
        moon.position.x=Math.cos(moon.userData.angle)*.85;
        moon.position.z=Math.sin(moon.userData.angle)*.85;
      }

      // Selection pulse
      if(selectedPlanet===i){const s=1+.04*Math.sin(Date.now()*.005);mesh.scale.set(s,s,s);}
      else mesh.scale.set(1,1,1);
    });
  }

  // Smooth camera
  const cz=camera.position.length();
  const smoothZ=cz+(targetZ-cz)*.1;
  camera.position.x=Math.sin(camRot)*smoothZ*Math.cos(camElev);
  camera.position.y=Math.sin(camElev)*smoothZ;
  camera.position.z=Math.cos(camRot)*smoothZ*Math.cos(camElev);

  if(selectedPlanet!==null)camera.lookAt(planetMeshes[selectedPlanet].position);
  else camera.lookAt(0,0,0);

  // Billboard labels
  labels.forEach(l=>l.quaternion.copy(camera.quaternion));

  renderer.render(scene,camera);
}
animate();
</script>
</body>
</html>
